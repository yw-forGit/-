<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 15">
<meta name=Originator content="Microsoft Word 15">
<link rel=File-List
href="10_SparkPerformanceOptimizationAndMalfunction.files/filelist.xml">
<link rel=Edit-Time-Data
href="10_SparkPerformanceOptimizationAndMalfunction.files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>shkstart</o:Author>
  <o:LastAuthor>Windows 用户</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>216</o:TotalTime>
  <o:Created>2019-09-04T08:17:00Z</o:Created>
  <o:LastSaved>2019-09-04T08:17:00Z</o:LastSaved>
  <o:Pages>21</o:Pages>
  <o:Words>4094</o:Words>
  <o:Characters>23340</o:Characters>
  <o:Lines>194</o:Lines>
  <o:Paragraphs>54</o:Paragraphs>
  <o:CharactersWithSpaces>27380</o:CharactersWithSpaces>
  <o:Version>15.00</o:Version>
 </o:DocumentProperties>
</xml><![endif]-->
<link rel=dataStoreItem
href="10_SparkPerformanceOptimizationAndMalfunction.files/item0001.xml"
target="10_SparkPerformanceOptimizationAndMalfunction.files/props002.xml">
<link rel=themeData
href="10_SparkPerformanceOptimizationAndMalfunction.files/themedata.thmx">
<link rel=colorSchemeMapping
href="10_SparkPerformanceOptimizationAndMalfunction.files/colorschememapping.xml">
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:TrackMoves>false</w:TrackMoves>
  <w:TrackFormatting/>
  <w:PunctuationKerning/>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:DoNotPromoteQF/>
  <w:LidThemeOther>EN-US</w:LidThemeOther>
  <w:LidThemeAsian>ZH-CN</w:LidThemeAsian>
  <w:LidThemeComplexScript>X-NONE</w:LidThemeComplexScript>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
   <w:SplitPgBreakAndParaMark/>
   <w:EnableOpenTypeKerning/>
   <w:DontFlipMirrorIndents/>
   <w:OverrideTableStyleHps/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:DoNotOptimizeForBrowser/>
  <m:mathPr>
   <m:mathFont m:val="Cambria Math"/>
   <m:brkBin m:val="before"/>
   <m:brkBinSub m:val="&#45;-"/>
   <m:smallFrac m:val="off"/>
   <m:dispDef/>
   <m:lMargin m:val="0"/>
   <m:rMargin m:val="0"/>
   <m:defJc m:val="centerGroup"/>
   <m:wrapIndent m:val="1440"/>
   <m:intLim m:val="subSup"/>
   <m:naryLim m:val="undOvr"/>
  </m:mathPr></w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" DefUnhideWhenUsed="false"
  DefSemiHidden="false" DefQFormat="false" DefPriority="99"
  LatentStyleCount="371">
  <w:LsdException Locked="false" Priority="0" QFormat="true" Name="Normal"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 1"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 2"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 3"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 4"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 5"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 6"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 7"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 8"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 9"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 9"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 1"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 2"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 3"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 4"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 5"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 6"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 7"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 8"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 9"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footnote text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="header"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footer"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index heading"/>
  <w:LsdException Locked="false" Priority="35" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="caption"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="table of figures"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="envelope address"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="envelope return"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footnote reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="line number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="page number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="endnote reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="endnote text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="table of authorities"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="macro"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="toa heading"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 5"/>
  <w:LsdException Locked="false" Priority="10" QFormat="true" Name="Title"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Closing"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Signature"/>
  <w:LsdException Locked="false" Priority="1" SemiHidden="true"
   UnhideWhenUsed="true" Name="Default Paragraph Font"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Message Header"/>
  <w:LsdException Locked="false" Priority="11" QFormat="true" Name="Subtitle"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Salutation"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Date"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text First Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text First Indent 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Note Heading"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Block Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Hyperlink"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="FollowedHyperlink"/>
  <w:LsdException Locked="false" Priority="22" QFormat="true" Name="Strong"/>
  <w:LsdException Locked="false" Priority="20" QFormat="true" Name="Emphasis"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Document Map"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Plain Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="E-mail Signature"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Top of Form"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Bottom of Form"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal (Web)"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Acronym"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Address"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Cite"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Code"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Definition"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Keyboard"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Preformatted"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Sample"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Typewriter"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Variable"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal Table"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation subject"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="No List"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Contemporary"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Elegant"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Professional"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Subtle 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Subtle 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Balloon Text"/>
  <w:LsdException Locked="false" Priority="39" Name="Table Grid"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Theme"/>
  <w:LsdException Locked="false" SemiHidden="true" Name="Placeholder Text"/>
  <w:LsdException Locked="false" Priority="1" QFormat="true" Name="No Spacing"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 1"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 1"/>
  <w:LsdException Locked="false" SemiHidden="true" Name="Revision"/>
  <w:LsdException Locked="false" Priority="34" QFormat="true"
   Name="List Paragraph"/>
  <w:LsdException Locked="false" Priority="29" QFormat="true" Name="Quote"/>
  <w:LsdException Locked="false" Priority="30" QFormat="true"
   Name="Intense Quote"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 1"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 1"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 2"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 2"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 2"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 3"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 3"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 3"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 4"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 4"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 4"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 5"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 5"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 5"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 6"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 6"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 6"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="19" QFormat="true"
   Name="Subtle Emphasis"/>
  <w:LsdException Locked="false" Priority="21" QFormat="true"
   Name="Intense Emphasis"/>
  <w:LsdException Locked="false" Priority="31" QFormat="true"
   Name="Subtle Reference"/>
  <w:LsdException Locked="false" Priority="32" QFormat="true"
   Name="Intense Reference"/>
  <w:LsdException Locked="false" Priority="33" QFormat="true" Name="Book Title"/>
  <w:LsdException Locked="false" Priority="37" SemiHidden="true"
   UnhideWhenUsed="true" Name="Bibliography"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="TOC Heading"/>
  <w:LsdException Locked="false" Priority="41" Name="Plain Table 1"/>
  <w:LsdException Locked="false" Priority="42" Name="Plain Table 2"/>
  <w:LsdException Locked="false" Priority="43" Name="Plain Table 3"/>
  <w:LsdException Locked="false" Priority="44" Name="Plain Table 4"/>
  <w:LsdException Locked="false" Priority="45" Name="Plain Table 5"/>
  <w:LsdException Locked="false" Priority="40" Name="Grid Table Light"/>
  <w:LsdException Locked="false" Priority="46" Name="Grid Table 1 Light"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark"/>
  <w:LsdException Locked="false" Priority="51" Name="Grid Table 6 Colorful"/>
  <w:LsdException Locked="false" Priority="52" Name="Grid Table 7 Colorful"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 1"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 1"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 1"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 2"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 2"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 2"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 3"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 3"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 3"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 4"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 4"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 4"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 5"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 5"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 5"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 6"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 6"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 6"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="46" Name="List Table 1 Light"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark"/>
  <w:LsdException Locked="false" Priority="51" Name="List Table 6 Colorful"/>
  <w:LsdException Locked="false" Priority="52" Name="List Table 7 Colorful"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 1"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 1"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 1"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 2"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 2"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 2"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 3"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 3"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 3"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 4"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 4"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 4"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 5"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 5"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 5"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 6"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 6"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 6"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 6"/>
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 680460288 22 0 262145 0;}
@font-face
	{font-family:黑体;
	panose-1:2 1 6 9 6 1 1 1 1 1;
	mso-font-alt:SimHei;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:-2147482945 953122042 22 0 262145 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;
	mso-font-charset:1;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:0 0 0 0 0 0;}
@font-face
	{font-family:等线;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:DengXian;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:-1610612033 953122042 22 0 262159 0;}
@font-face
	{font-family:微软雅黑;
	panose-1:2 11 5 3 2 2 4 2 2 4;
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-2147483001 718224464 22 0 262175 0;}
@font-face
	{font-family:华文细黑;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:647 135200768 16 0 262303 0;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-1610610945 1073750107 16 0 415 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 680460288 22 0 262145 0;}
@font-face
	{font-family:"\@黑体";
	panose-1:2 1 6 9 6 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:-2147482945 953122042 22 0 262145 0;}
@font-face
	{font-family:"\@等线";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:-1610612033 953122042 22 0 262159 0;}
@font-face
	{font-family:"\@微软雅黑";
	panose-1:2 11 5 3 2 2 4 2 2 4;
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-2147483001 718224464 22 0 262175 0;}
@font-face
	{font-family:"\@华文细黑";
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:647 135200768 16 0 262303 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-parent:"";
	margin-top:0cm;
	margin-right:25.25pt;
	margin-bottom:.45pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:22.55pt;
	line-height:125%;
	mso-pagination:widow-orphan;
	font-size:10.5pt;
	mso-bidi-font-size:11.0pt;
	font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	mso-font-kerning:1.0pt;}
h1
	{mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-parent:"";
	mso-style-link:"标题 1 Char";
	mso-style-next:正文;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:34.0pt;
	margin-bottom:.0001pt;
	text-indent:-.5pt;
	line-height:107%;
	mso-pagination:widow-orphan lines-together;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:22.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	mso-font-kerning:1.0pt;
	font-weight:normal;}
h2
	{mso-style-priority:9;
	mso-style-qformat:yes;
	mso-style-parent:"";
	mso-style-link:"标题 2 Char";
	mso-style-next:正文;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:15.15pt;
	margin-left:.5pt;
	text-indent:-.5pt;
	line-height:107%;
	mso-pagination:widow-orphan lines-together;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:16.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Arial","sans-serif";
	mso-fareast-font-family:Arial;
	color:black;
	mso-font-kerning:1.0pt;
	mso-bidi-font-weight:normal;}
h3
	{mso-style-priority:9;
	mso-style-qformat:yes;
	mso-style-parent:"";
	mso-style-link:"标题 3 Char";
	mso-style-next:正文;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:15.2pt;
	margin-left:.5pt;
	text-indent:-.5pt;
	line-height:107%;
	mso-pagination:widow-orphan lines-together;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:16.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Times New Roman","serif";
	mso-fareast-font-family:"Times New Roman";
	color:black;
	mso-font-kerning:1.0pt;
	mso-bidi-font-weight:normal;}
h4
	{mso-style-priority:9;
	mso-style-qformat:yes;
	mso-style-parent:"";
	mso-style-link:"标题 4 Char";
	mso-style-next:正文;
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:5.35pt;
	margin-left:21.5pt;
	text-indent:-.5pt;
	line-height:107%;
	mso-pagination:widow-orphan lines-together;
	page-break-after:avoid;
	mso-outline-level:4;
	font-size:11.0pt;
	font-family:黑体;
	mso-bidi-font-family:黑体;
	color:black;
	mso-font-kerning:1.0pt;
	font-weight:normal;}
span.2Char
	{mso-style-name:"标题 2 Char";
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-parent:"";
	mso-style-link:"标题 2";
	mso-ansi-font-size:16.0pt;
	font-family:"Arial","sans-serif";
	mso-ascii-font-family:Arial;
	mso-fareast-font-family:Arial;
	mso-hansi-font-family:Arial;
	mso-bidi-font-family:Arial;
	color:black;
	font-weight:bold;
	mso-bidi-font-weight:normal;}
span.3Char
	{mso-style-name:"标题 3 Char";
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-parent:"";
	mso-style-link:"标题 3";
	mso-ansi-font-size:16.0pt;
	font-family:"Times New Roman","serif";
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	font-weight:bold;
	mso-bidi-font-weight:normal;}
span.1Char
	{mso-style-name:"标题 1 Char";
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-parent:"";
	mso-style-link:"标题 1";
	mso-ansi-font-size:22.0pt;
	font-family:宋体;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;}
span.4Char
	{mso-style-name:"标题 4 Char";
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-parent:"";
	mso-style-link:"标题 4";
	mso-ansi-font-size:11.0pt;
	font-family:黑体;
	mso-ascii-font-family:黑体;
	mso-fareast-font-family:黑体;
	mso-hansi-font-family:黑体;
	mso-bidi-font-family:黑体;
	color:black;}
.MsoChpDefault
	{mso-style-type:export-only;
	mso-default-props:yes;
	font-family:等线;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;
	mso-footnote-separator:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") fs;
	mso-footnote-continuation-separator:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") fcs;
	mso-endnote-separator:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") es;
	mso-endnote-continuation-separator:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") ecs;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:14.2pt 14.2pt 14.2pt 14.2pt;
	mso-header-margin:0cm;
	mso-footer-margin:0cm;
	mso-even-header:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") eh1;
	mso-header:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") h1;
	mso-even-footer:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") ef1;
	mso-footer:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") f1;
	mso-first-header:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") fh1;
	mso-first-footer:url("10_SparkPerformanceOptimizationAndMalfunction.files/header.html") ff1;
	mso-paper-source:0;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 @list l0
	{mso-list-id:307828266;
	mso-list-type:hybrid;
	mso-list-template-ids:35945744 1320711418 168463088 -1247490374 1193730990 169003302 915202942 89446820 -221504128 493144662;}
@list l0:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:0cm;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l0:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1
	{mso-list-id:395780910;
	mso-list-type:hybrid;
	mso-list-template-ids:-1258900196 1625588918 -510889828 -1967630952 1021210842 -29181918 -1493694788 -587822500 -1822110282 1820467852;}
@list l1:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:38.15pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l1:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2
	{mso-list-id:556283826;
	mso-list-type:hybrid;
	mso-list-template-ids:1572395218 1989976364 -2108939404 1760727704 1603693102 -744166546 1819554232 -566474410 -227510128 -1337588990;}
@list l2:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:18.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:59.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:95.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:131.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:167.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:203.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:239.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:275.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l2:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:311.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3
	{mso-list-id:626281094;
	mso-list-type:hybrid;
	mso-list-template-ids:-1821709798 -1444762594 -1814390026 1841447492 -2025682154 1426619432 -1581196844 752098630 1971874444 33859794;}
@list l3:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:41.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l3:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4
	{mso-list-id:771125617;
	mso-list-type:hybrid;
	mso-list-template-ids:-2011029418 -639175908 557759676 720805868 -1494997024 729582702 -458718298 -633406468 -1392326574 -1875451804;}
@list l4:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:0cm;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l4:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5
	{mso-list-id:1260799395;
	mso-list-type:hybrid;
	mso-list-template-ids:-1745703448 336505066 -1088906896 -863106640 198986594 1336735438 -871889332 -521226396 -31565106 -470885784;}
@list l5:level1
	{mso-level-number-format:decimal-enclosed-circle;
	mso-level-text:%1;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:38.75pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:75.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:111.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:147.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:183.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:219.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:255.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:291.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l5:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:327.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:宋体;
	mso-fareast-font-family:宋体;
	mso-hansi-font-family:宋体;
	mso-bidi-font-family:宋体;
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6
	{mso-list-id:1383362999;
	mso-list-type:hybrid;
	mso-list-template-ids:-1304376552 177480110 2071475942 -1897633908 -663296650 -1597312546 2007950676 1531621386 626970890 632462906;}
@list l6:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:11.15pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l6:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7
	{mso-list-id:1450856717;
	mso-list-type:hybrid;
	mso-list-template-ids:676777752 2138842710 -137958784 -833592298 558286498 -1229435896 742012366 -1717412426 1848772462 2049731670;}
@list l7:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:0cm;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l7:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8
	{mso-list-id:1507329178;
	mso-list-type:hybrid;
	mso-list-template-ids:1572395218 1989976364 -2108939404 1760727704 1603693102 -744166546 1819554232 -566474410 -227510128 -1337588990;}
@list l8:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:18.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:59.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:95.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:131.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:167.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:203.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:239.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:275.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l8:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:311.35pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9
	{mso-list-id:1721517061;
	mso-list-type:hybrid;
	mso-list-template-ids:1887989138 -331823460 -702378900 2021431406 421314984 -1011680894 -2015588074 -1501555950 96527432 510969312;}
@list l9:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:23.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l9:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10
	{mso-list-id:1886332200;
	mso-list-type:hybrid;
	mso-list-template-ids:1623114958 -977893050 -727134822 741920120 854776988 -194375988 316553998 -547205098 -1157830290 -1362344828;}
@list l10:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:75.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:111.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:147.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:183.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:219.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:255.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:291.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l10:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:327.0pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11
	{mso-list-id:2073384920;
	mso-list-type:hybrid;
	mso-list-template-ids:1613557682 412286378 -245486768 -330423662 -1688811656 -1080418004 176179482 -40498542 25079242 -1088753968;}
@list l11:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:0cm;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level2
	{mso-level-number-format:alpha-lower;
	mso-level-text:%2;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:77.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level3
	{mso-level-number-format:roman-lower;
	mso-level-text:%3;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:113.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level4
	{mso-level-text:%4;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:149.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level5
	{mso-level-number-format:alpha-lower;
	mso-level-text:%5;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:185.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level6
	{mso-level-number-format:roman-lower;
	mso-level-text:%6;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:221.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level7
	{mso-level-text:%7;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:257.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level8
	{mso-level-number-format:alpha-lower;
	mso-level-text:%8;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:293.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
@list l11:level9
	{mso-level-number-format:roman-lower;
	mso-level-text:%9;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:329.05pt;
	text-indent:0cm;
	mso-ansi-font-size:10.5pt;
	mso-bidi-font-size:10.5pt;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	border:none;
	mso-ansi-font-weight:normal;
	mso-ansi-font-style:normal;
	text-underline:black;
	text-decoration:none;
	text-underline:none;
	text-decoration:none;
	text-line-through:none;
	vertical-align:baseline;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:普通表格;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.5pt;
	mso-bidi-font-size:11.0pt;
	font-family:等线;
	mso-ascii-font-family:等线;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:等线;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:等线;
	mso-hansi-theme-font:minor-latin;
	mso-font-kerning:1.0pt;}
table.TableGrid
	{mso-style-name:TableGrid;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-unhide:no;
	mso-style-parent:"";
	mso-padding-alt:0cm 0cm 0cm 0cm;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.5pt;
	mso-bidi-font-size:11.0pt;
	font-family:等线;
	mso-ascii-font-family:等线;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:等线;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:等线;
	mso-hansi-theme-font:minor-latin;
	mso-font-kerning:1.0pt;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2051"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=ZH-CN style='tab-interval:21.0pt'>

<div class=WordSection1>

<p class=MsoNormal align=center style='text-align:center'><b style='mso-bidi-font-weight:
normal'><span lang=EN-US style='font-size:24.0pt;mso-bidi-font-size:11.0pt;
line-height:125%'>Spark </span></b><b style='mso-bidi-font-weight:normal'><span
style='font-size:24.0pt;mso-bidi-font-size:11.0pt;line-height:125%'>高级课程<span
lang=EN-US><o:p></o:p></span></span></b></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:24.45pt;
margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:right;
text-indent:0cm;line-height:107%'><span style='font-size:12.0pt;mso-bidi-font-size:
11.0pt;line-height:107%'>作者：尚硅谷章鹏</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:21.5pt;margin-bottom:
8.85pt;margin-left:0cm;text-indent:0cm;line-height:107%'><span lang=EN-US
style='font-size:12.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:21.5pt;
margin-bottom:8.85pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span style='font-size:12.0pt;mso-bidi-font-size:11.0pt;
line-height:107%'>整理：小</span>邹<span lang=EN-US style='font-size:12.0pt;
mso-bidi-font-size:11.0pt;line-height:107%'>[yw_forgit@163.com]<o:p></o:p></span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:21.5pt;
margin-bottom:8.85pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal>调优是一把双刃剑，过度调优会导致性能下降，我们要根据实际环境，反复调试把参数调优到曲线的顶点附近。</p>

<h1 style='margin-top:0cm;margin-right:0cm;margin-bottom:19.65pt;margin-left:
-.25pt'>第一章 <b style='mso-bidi-font-weight:normal'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span></b>性能调优<b style='mso-bidi-font-weight:normal'><span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></b></h1>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:23.2pt;margin-left:
-.25pt'><span lang=EN-US>1.1 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>常规性能调优</span> </h2>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.1</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>最优资源配置</span> </h3>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:3.1pt;
margin-bottom:.3pt;margin-left:-.75pt;text-align:left'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark </span><span style='color:red'>性能调优的第一步，就是为任务分配更多的资源</span>，<span
style='color:red'>在一定范围内，增加资源的分配与性能的提升是成正比的</span>，实现了最优的资源配置后，在此基础上再考虑进行后面论述的性能调优策略。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:25.25pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:110%'>资源的分配在使用脚本提交 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>任务时进行指定，标准的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>任务提交脚</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.05pt;margin-left:-.75pt;text-indent:0cm'>本如代码清单 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-1
</span>所示：<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-1 </span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>标准</span><span lang=EN-US style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>Spark</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体'>提交脚本</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>/usr/opt/modules/spark/bin/spark-submit
\ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--class com.atguigu.spark.Analysis \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--num-executors 80 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--driver-memory 6g \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--executor-memory 6g \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--executor-cores 3 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.3pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>/usr/opt/modules/spark/jar/spark.jar \ </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.15pt;margin-left:23.05pt;text-indent:0cm'>可以进行分配的资源如表 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-1
</span>所示：<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:0cm;margin-left:.5pt;margin-bottom:.0001pt;text-align:center;
text-indent:-.5pt;line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>表 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-1 </span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>可分配资源表</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<table class=TableGrid border=0 cellspacing=0 cellpadding=0 width=710
 style='width:425.95pt;margin-left:-5.3pt;border-collapse:collapse;mso-yfti-tbllook:
 1184;mso-padding-alt:7.35pt 5.75pt 0cm 5.75pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;height:24.7pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-bottom:
  solid #70AD47 2.25pt;padding:7.35pt 5.75pt 0cm 5.75pt;height:24.7pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.3pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>名称 </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:solid #70AD47 1.0pt;border-left:
  none;border-bottom:solid #DBEBD0 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-left-alt:solid #70AD47 1.0pt;mso-border-alt:solid #70AD47 1.0pt;
  mso-border-bottom-alt:solid #DBEBD0 .25pt;padding:7.35pt 5.75pt 0cm 5.75pt;
  height:24.7pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.15pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>说明 </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;height:23.9pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-top:
  none;mso-border-top-alt:solid #70AD47 2.25pt;background:#DBEBD0;padding:7.35pt 5.75pt 0cm 5.75pt;
  height:23.9pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.75pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>--num-executors </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #DBEBD0 .25pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:7.35pt 5.75pt 0cm 5.75pt;height:23.9pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.05pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'>配置 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
  </span>的数量，也就是并行度，与<span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'>executor-cores</span><span style='font-family:等线;mso-bidi-font-family:
  等线'>作用差不多</span><span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;height:23.95pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-top:
  none;mso-border-top-alt:solid #70AD47 1.0pt;padding:7.35pt 5.75pt 0cm 5.75pt;
  height:23.95pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.75pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>--driver-memory </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:none;border-left:none;
  border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:7.35pt 5.75pt 0cm 5.75pt;height:23.95pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.15pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'>配置 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Driver </span>内存（影响不大）<span
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
  </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3;height:23.45pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-top:
  none;mso-border-top-alt:solid #70AD47 1.0pt;background:#DBEBD0;padding:7.35pt 5.75pt 0cm 5.75pt;
  height:23.45pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.75pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>--executor-memory </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:7.35pt 5.75pt 0cm 5.75pt;height:23.45pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.2pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'>配置每个 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
  </span>的内存大小，大多数<span lang=EN-US>OOM</span>溢出都是这个内存<span style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:4;mso-yfti-lastrow:yes;height:23.9pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-top:
  none;mso-border-top-alt:solid #70AD47 1.0pt;padding:7.35pt 5.75pt 0cm 5.75pt;
  height:23.9pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.8pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>--executor-cores </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:7.35pt 5.75pt 0cm 5.75pt;height:23.9pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:1.0pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'>配置每个 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
  </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>CPU core </span>数量<span
  lang=EN-US>(Executor</span>执行<span lang=EN-US>Task</span>的个数就是<span
  lang=EN-US>CPU</span>核数<span lang=EN-US>)</span><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
  </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>调节原则：<span style='color:red'>尽量将任务分配的资源调节到可以使用的资源的最大限度</span>。对于具体资源的分配，我们分别讨论
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>的两种 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Cluster </span>运行模式：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>第一种是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Spark Standalone </span><span style='color:red'>模式</span>，你在提交任务前，一定知道或者可以从运维部门获取到你可以使用的资源情况，<span
style='color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>在编写 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>submit
</span><span style='color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>脚本的时候，就根据可用的资源情况进行资源的分配</span>，比如说集群有
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>15 </span>台机器，每台机器为 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>8G </span>内存，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>CPU core</span>，那么就指定 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>15 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor</span>，每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>分配 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>8G </span>内存，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2
</span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>CPU core</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
.45pt;margin-left:-.75pt'>第二种是 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Spark Yarn </span><span
style='color:red'>模式</span>，由于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Yarn </span>使用<span
style='color:red'>资源队列</span>进行资源的分配和调度，<span style='color:#C45911;mso-themecolor:
accent2;mso-themeshade:191'>在表写 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:#C45911;
mso-themecolor:accent2;mso-themeshade:191'>submit </span><span
style='color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>脚本的时候，就根据 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>Spark
</span><span style='color:#C45911;mso-themecolor:accent2;mso-themeshade:191'>作业要提交到的资源队列，进行资源的分配</span>，比如资源队列有
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>400G </span>内存，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>100 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU
core</span>，那么指定 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>50 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor</span>，每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Executor </span>分配 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>8G </span>内存，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2
</span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>CPU core</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:51.95pt;margin-bottom:
.45pt;margin-left:148.25pt;text-indent:-125.2pt'>对表 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-1
</span>中的各项资源进行了调节后，得到的性能提升如表 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-2 </span>所示：<span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:125%;font-family:
黑体;mso-bidi-font-family:黑体'>表 </span><span lang=EN-US style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:125%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>2-2 </span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:125%;font-family:黑体;mso-bidi-font-family:
黑体'>资源调节后的性能提升</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:125%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>
</span></p>

<table class=TableGrid border=0 cellspacing=0 cellpadding=0 width=710
 style='width:425.95pt;margin-left:-5.3pt;border-collapse:collapse;mso-yfti-tbllook:
 1184;mso-padding-alt:4.7pt .4pt 0cm 5.35pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;height:24.55pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-bottom:
  solid #70AD47 2.25pt;padding:4.7pt .4pt 0cm 5.35pt;height:24.55pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:6.25pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>名称 </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:solid #70AD47 1.0pt;border-left:
  none;border-bottom:solid #DBEBD0 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-left-alt:solid #70AD47 1.0pt;mso-border-alt:solid #70AD47 1.0pt;
  mso-border-bottom-alt:solid #DBEBD0 .25pt;padding:4.7pt .4pt 0cm 5.35pt;
  height:24.55pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:6.1pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>解析 </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;height:122.95pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 2.25pt;background:#DBEBD0;
  padding:4.7pt .4pt 0cm 5.35pt;height:122.95pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.85pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:5.95pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>增加<span lang=EN-US> Executor·</span>个数 </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #DBEBD0 .25pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:4.7pt .4pt 0cm 5.35pt;height:122.95pt'>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.25pt;margin-bottom:
  0cm;margin-left:0cm;margin-bottom:.0001pt;text-indent:11.5pt;line-height:
  128%'><span style='color:red'>在资源允许的情况下，增加 </span><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
  color:red'>Executor </span><span style='color:red'>的个数可以提高执行 </span><span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman";color:red'>task </span><span style='color:red'>的并行度</span>。比如有
  <span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>4 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>Executor</span>，每个 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>Executor </span>有 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2</span></p>
  <p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:2.65pt;
  margin-left:0cm;text-indent:0cm;line-height:107%'>个 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU
  core</span>，那么可以并行执行 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>8 </span>个 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task</span>，</p>
  <p class=MsoNormal style='margin:0cm;margin-bottom:.0001pt;text-indent:0cm;
  line-height:127%'>如果将 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>Executor </span>的个数增加到 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>8 </span>个（资源允许的情况下），那么可以并行执行</p>
  <p class=MsoNormal style='margin:0cm;margin-bottom:.0001pt;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>16 </span>个 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task</span>，此时的并行能力提升了一倍。<span
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
  </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;height:139.55pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;padding:4.7pt .4pt 0cm 5.35pt;
  height:139.55pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.85pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:6.1pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>增加每个<span lang=EN-US> Executor </span>的<span lang=EN-US> CPU core </span>个数
  </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:none;border-left:none;
  border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:4.7pt .4pt 0cm 5.35pt;height:139.55pt'>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.4pt;margin-bottom:
  .25pt;margin-left:0cm;text-indent:0cm;line-height:127%'><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
  style='mso-spacerun:yes'>  </span></span><span style='color:red'>在资源允许的情况下，增加每个
  </span><span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
  style='color:red'>的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman";color:red'>Cpu core </span><span
  style='color:red'>个数，可以提高执行 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
  style='color:red'>的并行度</span>。比如有 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>4 </span>个 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor</span>，每个
  <span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>Executor </span>有 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2 </span>个
  <span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>CPU core</span>，那么可以并行执行 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>8
  </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>task</span>，如果将每个 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>Executor </span>的 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU core
  </span>个数增加到 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>4 </span>个（资源允许</p>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'>的情况下），那么可以并行执行 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>16 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>task</span>，此时的并行能力提升了一倍。<span
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
  </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3;mso-yfti-lastrow:yes;height:175.1pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;background:#DBEBD0;
  padding:4.7pt .4pt 0cm 5.35pt;height:175.1pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.8pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.7pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.8pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.35pt;
  margin-bottom:7.75pt;margin-left:0cm;text-align:center;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-family:等线;mso-bidi-font-family:
  等线'><span style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:6.1pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>增加每个<span lang=EN-US> Executor </span>的内存量 </span></p>
  </td>
  <td width=355 valign=bottom style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:4.7pt .4pt 0cm 5.35pt;height:175.1pt'>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.85pt;margin-bottom:
  3.1pt;margin-left:0cm;text-indent:0cm;line-height:128%'><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
  style='mso-spacerun:yes'>  </span></span>在资源允许的情况下，增加每个 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
  </span>的内存量以后，对性能的提升有三点：<span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.8pt;margin-bottom:
  3.7pt;margin-left:18.0pt;text-indent:0cm'><span lang=EN-US style='color:windowtext'>1.</span><span
  style='color:red'>可以缓存更多的数据</span>（即对 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>进行
  <span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>cache</span>），写入磁盘的数据相应减少，甚至可以不写入磁盘，减少了可能的磁盘 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>IO</span>；<span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.8pt;margin-bottom:
  0cm;margin-left:0cm;margin-bottom:.0001pt;line-height:107%'><span lang=EN-US
  style='color:windowtext'>2.</span><span style='color:red'>可以为 </span><span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman";color:red'>shuffle </span><span style='color:red'>操作提供更多内存</span>，即有更多空间来存放
  <span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>reduce </span>端拉取的数据，写入磁盘的数据相应减少，甚至可以不写入磁盘，减少了可能的磁盘<span
  lang=EN-US>IO</span>； </p>
  <p class=MsoNormal style='margin-top:0cm;margin-right:5.8pt;margin-bottom:
  0cm;margin-left:18.0pt;margin-bottom:.0001pt;text-indent:0cm;line-height:
  107%'><span lang=EN-US>3. </span><span style='color:red'>可以为<span lang=EN-US>
  task </span>的执行提供更多内存</span>，在<span lang=EN-US> task </span>的执行过程中可能创建很多对象，内存较小时会引发频繁的<span
  lang=EN-US> GC</span>，增加内存后，可以避免频繁的<span lang=EN-US> GC</span>，提升整体性能。</p>
  </td>
 </tr>
</table>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:8.5pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
107%'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial'><span
style='mso-spacerun:yes'> </span></span></p>

<h4 style='margin-top:0cm;margin-right:67.05pt;margin-bottom:.45pt;margin-left:
22.8pt'>补充：生产环境 <span lang=EN-US style='font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>Spark submit </span>脚本配置<span style='font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial'> </span></h4>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>/usr/local/spark/bin/spark-submit \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--class
com.ibeifeng.sparkstudy.WordCount \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--num-executors 80 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--driver-memory 6g \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--executor-memory 6g \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--executor-cores 3 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--master yarn-cluster \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--queue root.default \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--conf
spark.yarn.executor.memoryOverhead=2048 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--conf
spark.core.connection.ack.wait.timeout=300 \ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.2pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>/usr/local/spark/spark.jar </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>参数配置参考值：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:170.05pt;margin-bottom:
.15pt;margin-left:21.5pt;text-indent:-.5pt;line-height:130%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>--num-executors</span>：<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>50~100 --driver-memory</span>：<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>1G~5G
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
1.7pt;margin-left:21.5pt;text-indent:-.5pt;line-height:107%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>--executor-memory</span>：<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>6G~10G </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
2.0pt;margin-left:21.5pt;text-indent:-.5pt;line-height:107%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>--executor-cores</span>：<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3 </span></p>

<p class=MsoNormal style='margin-left:22.55pt;text-indent:0cm'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>--master</span>：实际生产环境一定使用<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
yarn-cluster <o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:22.55pt;text-indent:0cm'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.yarn.executor.memoryOverhead </span>指定堆外内存的大小，默认是<span
lang=EN-US>Executor</span>内存的<span lang=EN-US>10%</span>，<span lang=EN-US>10%</span>一般都不够</p>

<p class=MsoNormal style='margin-left:22.55pt;text-indent:0cm'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.core.connection.ack.wait.timeout </span>等待时长，<span
lang=EN-US>Executor</span>拉取其他<span lang=EN-US>Executor</span>的数据时，如果无法访问会等待一会<span
lang=EN-US>(</span>就是这个等待<span lang=EN-US>)</span>，然后重试拉取<span lang=EN-US>(</span>次数也可以设置<span
lang=EN-US>)</span>，不行才会报错。<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><o:p></o:p></span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.2RDD </span><span style='font-family:宋体;
mso-bidi-font-family:宋体;font-weight:normal'>优化</span> </h3>

<h4 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'>1.2.1 RDD </span>复用<span style='font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></h4>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
3.55pt;margin-left:-.75pt'>在对 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>进行算子时，要避免相同的算子和计算逻辑之下对 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>进行重复的计算，如图 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-1 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:38.9pt;
margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:right;
text-indent:0cm;line-height:107%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shapetype
 id="_x0000_t75" coordsize="21600,21600" o:spt="75" o:preferrelative="t"
 path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f">
 <v:stroke joinstyle="miter"/>
 <v:formulas>
  <v:f eqn="if lineDrawn pixelLineWidth 0"/>
  <v:f eqn="sum @0 1 0"/>
  <v:f eqn="sum 0 0 @1"/>
  <v:f eqn="prod @2 1 2"/>
  <v:f eqn="prod @3 21600 pixelWidth"/>
  <v:f eqn="prod @3 21600 pixelHeight"/>
  <v:f eqn="sum @0 0 1"/>
  <v:f eqn="prod @6 1 2"/>
  <v:f eqn="prod @7 21600 pixelWidth"/>
  <v:f eqn="sum @8 21600 0"/>
  <v:f eqn="prod @7 21600 pixelHeight"/>
  <v:f eqn="sum @10 21600 0"/>
 </v:formulas>
 <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/>
 <o:lock v:ext="edit" aspectratio="t"/>
</v:shapetype><v:shape id="Picture_x0020_860" o:spid="_x0000_i1043" type="#_x0000_t75"
 style='width:381pt;height:96pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image001.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=635 height=160
src="10_SparkPerformanceOptimizationAndMalfunction.files/image002.jpg" v:shapes="Picture_x0020_860"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:10.75pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%'>图 </span><span lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-1 RDD </span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%'>的重复计算</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>对图 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-1
</span>中的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>计算架构进行修改，得到如图 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-2 </span>所示的优化结果：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:29.5pt;
margin-bottom:11.0pt;margin-left:166.25pt;text-align:left;text-indent:-149.55pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_915" o:spid="_x0000_i1042" type="#_x0000_t75" style='width:381.6pt;
 height:90.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image003.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=636 height=151
src="10_SparkPerformanceOptimizationAndMalfunction.files/image004.jpg" v:shapes="Picture_x0020_915"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-2
RDD </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:
104%'>架构优化</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> <span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal>比如说，把一个<span lang=EN-US>RDD</span>的结果放到两个算子中，这俩算子进来都要<span
lang=EN-US>groupby</span>一下，那就可以优化为先对那个<span lang=EN-US>RDDgroupby</span>了之后，再传递到那两个算子中。</p>

<h4 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'>1.2.2 RDD </span>持久化<span style='font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></h4>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>中，当多次对同一个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>执行算子操作时，每一次都会对这个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>以之前的父 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>重新计算一次，这种情况是必须要避免的，对同一个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>的重复计算是对资源的极大浪费，因此，<span style='color:red'>必须对多次使用的
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>进行持久化</span>，通过持久化将公共 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>的数据缓存到内存<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>/</span>磁盘中，之后对于公共 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>的计算都会从内存<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>/</span>磁盘中直接获取
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>数据。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>对于 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>的持久化，有两点需要说明：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>第一，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>的持久化是可以进行<span
style='color:red'>序列化</span>的，当内存无法将 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>的数据完整的进行存放的时候，可以考虑使用序列化的方式减小数据体积，将数据完整存储在内存中。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:6.35pt;margin-left:-.75pt;text-align:left;line-height:125%'>第二，如果对于数据的可靠性要求很高，并且内存充足，可以使用<span
style='color:red'>副本机制</span>，对 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>数据进行持久化。当持久化启用了复本机制时，对于持久化的每个数据单元都存储一个副本，放在其他节点上面，由此实现数据的容错，一旦一个副本数据丢失，不需要重新计算，还可以使用另外一个副本。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h4 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'>1.2.3 RDD </span>尽可能早的 <span lang=EN-US style='font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>filter </span>操作<span style='font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></h4>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.5pt;margin-left:-.75pt'>获取到初始 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>后，应该考虑尽早地过滤掉不需要的数据，进而减少对内存的占用，从而提升
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的运行效率。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.3</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>并行度调节</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>作业中的并行度指<span
style='color:red'>各个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>stage </span><span
style='color:red'>的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>的数量</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>如果并行度设置不合理而导致并行度过低，会导致资源的极大浪费，例如，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>20 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor</span>，每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>分配 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>3 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU
core</span>，而 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业有 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>40
</span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task</span>，这样每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>分配到的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>个数是 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2
</span>个，这就使得每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>有一个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>CPU core </span>空闲，导致资源的浪费。</p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>理想的并行度设置，应该是<span
style='color:red'>让并行度与资源相匹配</span>，简单来说就是<span style='color:red'>在资源允许的前提下，并行度要设置的尽可能大，达到可以充分利用集群资源</span>。合理的设置并行度，可以提升整个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的性能和运行速度。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>官方推荐，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>数量应该设置为 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Spark </span><span
style='color:red'>作业总 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>CPU core </span><span
style='color:red'>数量的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>2~3 </span><span
style='color:red'>倍</span>。之所以没有推荐 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>数量与 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU
core </span>总数相等，是因为 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>的执行时间不同，有的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>执行速度快而有的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>执行速度慢，如果
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>数量与 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>CPU core </span>总数相等，那么执行快的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>执行完成后，会出现 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU core </span>空闲的情况（有时候有些<span
lang=EN-US>CPU</span>很忙，忙完一个继续忙下一个任务，而有些<span lang=EN-US>CPU</span>很闲<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span>，一次都没有执行，这个可能是数据本地化问题，宁可让<span lang=EN-US>cpu</span>闲着也不愿意跨机器拷贝数据。）。如果 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>数量设置为 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>CPU core </span>总数的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2~3 </span>倍，那么一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>执行完毕后，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>CPU
core </span>会立刻执行下一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task</span>，降低了资源的浪费，同时提升了 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业运行的效率。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span>（数据清洗是在<span lang=EN-US>Shuffle</span>阶段。）</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.0pt;margin-left:21.0pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>作业并行度的设置如代码清单
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-2 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-2 Spark</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>作业并行度设置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.default.parallelism</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;500&quot;) </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.4</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>广播大变量</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:18.0pt'>默认情况下，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>中的算子中如果使用了外部的变量，每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>都会获取一份变量的复本，这就造成了内存的极大消耗。一方面，如果后续对
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>进行持久化，可能就无法将 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>数据存入内存，只能写入磁盘，磁盘
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>IO </span>将会严重消耗性能；另一方面，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>在创建对象的时候，也许会发现堆内存无法存放新创建的对象，这就会导致频繁的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>GC</span>，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>GC </span>会导致工作线程停止，进而导致 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>暂停工作一段时间，严重影响 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span>性能。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;text-indent:18.0pt;
line-height:125%'>假设当前任务配置了 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>20 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor</span>，指定
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>500 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task</span>，有一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>20M
</span>的变量被所有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>共用，此时会在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>500 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>中产生 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>500
</span>个副本，耗费集群 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10G </span>的内存，如果使用了广播变量，<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span>那么每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>保存一个副本，一共消耗 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>400M </span>内存，内存消耗减少了 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>5 </span>倍。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:18.0pt;line-height:125%'><span
style='color:red'>广播变量在每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
style='color:red'>保存一个副本，此 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
style='color:red'>的所有 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>共用此广播变量，这让变量产生的副本数量大大减少<span lang=EN-US>(</span>如果是每个<span
lang=EN-US>Task</span>一份，其实就是在<span lang=EN-US>Executor</span>内存中存了好几份，因为<span
lang=EN-US>Task</span>的内存其实就是向<span lang=EN-US>Executor</span>申请的<span
lang=EN-US>)</span></span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.45pt;margin-left:-.75pt;text-indent:18.0pt'>在初始阶段，广播变量只在 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Driver
</span>中有一份副本。<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>在运行的时候，想要使用广播变量中的数据，此时首先会在自己本地的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Executor </span>对应的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>BlockManager
</span>中尝试获取变量，<span style='color:red'>如果本地没有，</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>BlockManager </span><span style='color:red'>就会从 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Driver </span><span style='color:red'>或者其他节点的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>BlockManager </span><span style='color:red'>上远程拉取变量的复本</span>，并由本地的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>进行管理；之后此 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>的所有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>都会直接从本地的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>中获取变量。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.5Kryo </span><span style='font-family:宋体;
mso-bidi-font-family:宋体;font-weight:normal'>序列化</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>默认情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Java
</span>的序列化机制<span lang=EN-US>(Java</span>的序列化效率很低，有很多校验之类的，比如那个<span
lang=EN-US>version</span>，需要注意的是，如果<span lang=EN-US>checkpoint</span>之后，修改了代码可能会导致反序列化报错<span
lang=EN-US>)</span>。<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Java </span>的序列化机制使用方便，不需要额外的配置，在算子中使用的变量实现
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Serializable </span>接口即可，但是，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Java
</span>序列化机制的效率不高，序列化速度慢并且序列化后的数据所占用的空间依然较大。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Kryo </span>序列化机制比 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Java
</span>序列化机制性能提高 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>倍左右，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span>之所以没有默认使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Kryo </span>作为序列化类库，是因为它不支持所有对象的序列化，同时
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Kryo </span><span style='color:red'>需要用户在使用前注册需要序列化的类型</span>，不够方便，但从
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark 2.0.0 </span>版本开始，简单类型、简单类型数组、字符串类型的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Shuffling
RDDs </span>已经默认使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Kryo </span>序列化方式了。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:100.35pt;margin-bottom:
.45pt;margin-left:131.1pt;text-indent:-108.05pt;line-height:194%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Kryo </span>序列化注册方式的实例代码如代码清单 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-3
</span>所示：<span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:
194%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span lang=EN-US
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:194%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial'>2-3 Kryo</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:194%;font-family:
黑体;mso-bidi-font-family:黑体'>序列化机制配置代码</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:194%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<table class=TableGrid border=0 cellspacing=0 cellpadding=0 width=697
 style='width:418.25pt;margin-left:-1.45pt;border-collapse:collapse;mso-yfti-tbllook:
 1184;mso-padding-alt:3.85pt 5.75pt 0cm 1.45pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:87.95pt'>
  <td width=697 valign=top style='width:418.25pt;background:#E0E0E0;padding:
  3.85pt 5.75pt 0cm 1.45pt;height:87.95pt'>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:127.8pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:left;
  text-indent:0cm;line-height:120%'><span lang=EN-US style='font-size:8.0pt;
  mso-bidi-font-size:11.0pt;line-height:120%;font-family:"Courier New";
  mso-fareast-font-family:"Courier New"'>public class MyKryoRegistrator
  implements </span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
  11.0pt;line-height:120%;font-family:"Courier New";mso-fareast-font-family:
  "Courier New";color:red'>KryoRegistrator</span><span lang=EN-US
  style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:120%;font-family:
  "Courier New";mso-fareast-font-family:"Courier New"'> { </span></p>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:220.6pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:left;
  text-indent:0cm;line-height:120%'><span lang=EN-US style='font-size:8.0pt;
  mso-bidi-font-size:11.0pt;line-height:120%;font-family:"Courier New";
  mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
  </span>@Override<span style='mso-spacerun:yes'>   </span>public void
  registerClasses(Kryo kryo) </span></p>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:205.95pt;
  margin-bottom:.1pt;margin-left:0cm;text-align:left;text-indent:0cm;
  line-height:119%'><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
  11.0pt;line-height:119%;font-family:"Courier New";mso-fareast-font-family:
  "Courier New";color:#538135;mso-themecolor:accent6;mso-themeshade:191'><span
  style='mso-spacerun:yes'> </span>// </span><span style='font-size:8.0pt;
  mso-bidi-font-size:11.0pt;line-height:119%;color:#538135;mso-themecolor:accent6;
  mso-themeshade:191'>要注册需要序列化的类，序列化的时候才会使用<span lang=EN-US>Kry</span></span><span
  lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:119%;
  font-family:"Courier New";mso-fareast-font-family:"Courier New"'> {<span
  style='mso-spacerun:yes'>     </span>kryo.register(StartupReportLogs.class); <span
  style='mso-spacerun:yes'> </span></span></p>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
  margin-bottom:1.2pt;margin-left:0cm;text-align:left;text-indent:0cm;
  line-height:107%'><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
  11.0pt;line-height:107%;font-family:"Courier New";mso-fareast-font-family:
  "Courier New"'><span style='mso-spacerun:yes'>  </span>} </span></p>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'><span lang=EN-US
  style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
  "Courier New";mso-fareast-font-family:"Courier New"'>} </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.1pt;margin-left:23.05pt;text-indent:0cm'>配置 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Kryo
</span>序列化方式的实例代码如代码清单 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-4 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.35pt;
margin-bottom:3.9pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-4 Kryo</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>序列化机制配置代码</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:.25pt;margin-left:-.4pt;text-align:left;text-indent:0cm;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New";color:#70AD47'>//</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;color:#70AD47'>创建</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'>SparkConf</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;color:#70AD47'>对象</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:.85pt;margin-left:-.4pt;text-align:left;text-indent:0cm;
line-height:108%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:108%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new
SparkConf().setMaster(…).setAppName(…) <o:p></o:p></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:.85pt;margin-left:-.4pt;text-align:left;text-indent:0cm;
line-height:108%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:108%;font-family:"Courier New";
mso-fareast-font-family:"Courier New";color:#70AD47'>//</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;color:#70AD47'>使用</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'>Kryo</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;color:#70AD47'>序列化库，如果要使用</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'>Java</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;color:#70AD47'>序列化库，需要把该行屏蔽掉</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:108%;font-family:
"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:.1pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>conf.set(&quot;</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
"Courier New";mso-fareast-font-family:"Courier New";color:#00B0F0'>spark.serializer</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Courier New";mso-fareast-font-family:"Courier New"'>&quot;,
&quot;org.apache.spark.serializer.KryoSerializer&quot;);<span
style='mso-spacerun:yes'>   </span></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:25.05pt;margin-left:.1pt;text-align:left;text-indent:-.5pt;
line-height:134%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:134%;font-family:"Courier New";
mso-fareast-font-family:"Courier New";color:#70AD47'>//</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;color:#70AD47'>在</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'>Kryo</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;color:#70AD47'>序列化库中注册自定义的类集合，如果要使用</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'>Java</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;color:#70AD47'>序列化库，需要把该行屏蔽掉</span><span
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;font-family:
"Courier New";mso-fareast-font-family:"Courier New";color:#70AD47'> </span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;
font-family:"Courier New";mso-fareast-font-family:"Courier New"'>conf.set(&quot;</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#00B0F0'>spark.kryo.registrator</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:134%;
font-family:"Courier New";mso-fareast-font-family:"Courier New"'>&quot;,
&quot;atguigu.com.MyKryoRegistrator&quot;);<span style='mso-spacerun:yes'> 
</span></span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.1.6</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>调节本地化等待时长</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业运行过程中，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Driver </span>会对每一个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>stage </span>的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>进行分配。<span style='color:red'>根据 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Spark </span><span style='color:red'>的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>分配算法，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Spark </span><span style='color:red'>希望 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>能够运行在它要计算的数据算在的节点</span>（数据本地化思想），这样就可以避免数据的网络传输。通常来说，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>可能不会被分配到它处理的数据所在的节点，因为这些节点可用的资源可能已经用尽，此时，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>会等待一段时间，默认 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>3s</span>，<span
style='color:red'>如果等待指定时间后仍然无法在指定节点运行，那么会自动降级，尝试将 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>task </span><span style='color:red'>分配到比较差的本地化级别所对应的节点上</span>，比如将 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>分配到离它要计算的数据比较近的一个节点，然后进行计算，<span
style='color:red'>如果当前级别仍然不行，那么继续降级</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>要处理的数据不在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>所在节点上时，会发生数据的传输。<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>会通过所在节点的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>BlockManager </span>获取数据，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>发现数据不在本地时，户通过网络传输组件从数据所在节点的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>处获取数据。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>网络传输数据的情况是我们不愿意看到的，大量的网络传输会严重影响性能，因此，我们希望通过调节本地化等待时长，如果在等待时长这段时间内，目标节点处理完成了一部分
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task</span>，那么当前的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>将有机会得到执行，这样就能够改善 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的整体性能。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
5.9pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>的本地化等级如表
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-3 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:0cm;margin-left:.5pt;margin-bottom:.0001pt;text-align:center;
text-indent:-.5pt;line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>表 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-3 Spark</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>本地化等级</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<table class=TableGrid border=0 cellspacing=0 cellpadding=0 width=710
 style='width:425.95pt;margin-left:-5.3pt;border-collapse:collapse;mso-yfti-tbllook:
 1184;mso-padding-alt:4.85pt 5.75pt 0cm 5.35pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;height:24.7pt'>
  <td width=355 style='width:212.95pt;border:solid #70AD47 1.0pt;border-bottom:
  solid #70AD47 2.25pt;padding:4.85pt 5.75pt 0cm 5.35pt;height:24.7pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.85pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>名称 </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:solid #70AD47 1.0pt;border-left:
  none;border-bottom:solid #DBEBD0 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-left-alt:solid #70AD47 1.0pt;mso-border-alt:solid #70AD47 1.0pt;
  mso-border-bottom-alt:solid #DBEBD0 .25pt;padding:4.85pt 5.75pt 0cm 5.35pt;
  height:24.7pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.7pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span style='font-family:等线;mso-bidi-font-family:
  等线'>解析 </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;height:40.35pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 2.25pt;background:#DBEBD0;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:40.35pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.2pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>PROCESS_LOCAL </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #DBEBD0 .25pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:4.85pt 5.75pt 0cm 5.35pt;height:40.35pt'>
  <p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:2.8pt;
  margin-left:0cm;text-indent:0cm;line-height:107%'>进程本地化， <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
  </span>和数据在同一个</p>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
  </span>中，性能最好。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'> </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;height:37.35pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;padding:4.85pt 5.75pt 0cm 5.35pt;
  height:37.35pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.4pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>NODE_LOCAL </span></p>
  </td>
  <td width=355 valign=bottom style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:37.35pt'>
  <p class=MsoNormal style='margin:0cm;margin-bottom:.0001pt;text-indent:0cm;
  line-height:107%'>节点本地化，<span lang=EN-US style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'>task </span>和数据在同一个节点中，但是 <span
  lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
  "Times New Roman"'>task </span>和数据不在同一个 <span lang=EN-US style='font-family:
  "Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor</span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3;height:20.75pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;padding:4.85pt 5.75pt 0cm 5.35pt;
  height:20.75pt'>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
  margin-bottom:8.0pt;margin-left:0cm;text-align:left;text-indent:0cm;
  line-height:107%'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:20.75pt'>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'>中，数据需要在进程间进行传输。<span
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
  </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:4;height:56.4pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;background:#DBEBD0;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:56.4pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.35pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>RACK_LOCAL </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:4.85pt 5.75pt 0cm 5.35pt;height:56.4pt'>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'>机架本地化，<span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
  </span>和数据在同一个机架的两个节点上，数据需要通过网络在节点之间进行传输。<span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:5;height:40.45pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;padding:4.85pt 5.75pt 0cm 5.35pt;
  height:40.45pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.25pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>NO_PREF </span></p>
  </td>
  <td width=355 style='width:213.0pt;border-top:none;border-left:none;
  border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:40.45pt'>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'>对于 <span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
  </span>来说，从哪里获取都一样，没有好坏之分。<span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:6;mso-yfti-lastrow:yes;height:40.0pt'>
  <td width=355 valign=top style='width:212.95pt;border:solid #70AD47 1.0pt;
  border-top:none;mso-border-top-alt:solid #70AD47 1.0pt;background:#DBEBD0;
  padding:4.85pt 5.75pt 0cm 5.35pt;height:40.0pt'>
  <p class=MsoNormal align=center style='margin-top:0cm;margin-right:.35pt;
  margin-bottom:0cm;margin-left:0cm;margin-bottom:.0001pt;text-align:center;
  text-indent:0cm;line-height:107%'><span lang=EN-US style='font-family:等线;
  mso-bidi-font-family:等线'>ANY </span></p>
  </td>
  <td width=355 valign=top style='width:213.0pt;border-top:none;border-left:
  none;border-bottom:solid #70AD47 1.0pt;border-right:solid #70AD47 1.0pt;
  mso-border-top-alt:solid #70AD47 1.0pt;mso-border-left-alt:solid #70AD47 1.0pt;
  background:#DBEBD0;padding:4.85pt 5.75pt 0cm 5.35pt;height:40.0pt'>
  <p class=MsoNormal align=left style='margin:0cm;margin-bottom:.0001pt;
  text-align:left;text-indent:0cm;line-height:107%'><span lang=EN-US
  style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
  </span>和数据可以在集群的任何地方，而且不在一个机架中，性能最差。<span style='font-family:"Times New Roman","serif";
  mso-fareast-font-family:"Times New Roman"'> </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>项目开发阶段，可以使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>client </span>模式对程序进行测试，此时，可以在本地看到比较全的日志信息，日志信息中有明确的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>数据本地化的级别，如果大部分都是 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>PROCESS_LOCAL</span>，那么就无需进行调节，但是如果发现很多的级别都是
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>NODE_LOCAL</span>、<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>ANY</span>，那么需要对本地化的等待时长进行调节，通过延长本地化等待时长，看看
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>的本地化级别有没有提升，并观察 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span>作业的运行时间有没有缩短。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>注意，<span style='color:red'>过犹不及</span>，不要将本地化等待时长延长地过长，导致因为大量的等待时长，使得
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的运行时间反而增加了。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.2pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>本地化等待时长的设置如代码清单
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-5 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-5 Spark</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>本地化等待时长设置示例</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.locality.wait</span><span lang=EN-US style='font-size:
8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>&quot;, &quot;6&quot;) </span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#538135;
mso-themecolor:accent6;mso-themeshade:191'>// 6</span><span style='font-size:
8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;color:#538135;mso-themecolor:
accent6;mso-themeshade:191'>秒，<span lang=EN-US>2</span>倍这样扩</span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:23.0pt;margin-left:
-.25pt'><span lang=EN-US>1.2 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>算子调优</span> </h2>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.2.1</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
lang=EN-US>mapPartitions </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
.45pt;margin-left:-.75pt'>普通的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>算子对 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>中的每一个元素（每一条）进行操作，而 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>mapPartitions </span>算子对 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>中每一个分区进行操作。如果是普通的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>算子，假设一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>partition </span>有 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>1
</span>万条数据，那么 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>算子中的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>function
</span>要执行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>1 </span>万次，也就是对每个元素进行操作。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:91.8pt;margin-bottom:.0001pt;text-align:left;
text-indent:0cm;line-height:107%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_1913" o:spid="_x0000_i1041" type="#_x0000_t75" style='width:252.6pt;
 height:151.8pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image005.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=421 height=253
src="10_SparkPerformanceOptimizationAndMalfunction.files/image006.jpg" v:shapes="Picture_x0020_1913"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:10.55pt;margin-left:0cm;text-align:center;text-indent:0cm;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%'>图 </span><span lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-3 map </span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%'>算子</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.25pt;margin-bottom:
3.5pt;margin-left:-.75pt;text-indent:21.0pt;line-height:127%'>如果是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>mapPartition </span>算子，由于<span style='color:red'>一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>处理一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>RDD </span><span style='color:red'>的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>partition</span>，那么<span style='color:red'>一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>只会执行一次 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>function</span><span style='color:red'>，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>function </span><span style='color:red'>一次接收所有的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>partition </span><span style='color:red'>数据</span>，效率比较高。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:99.85pt;
margin-bottom:11.0pt;margin-left:160.35pt;text-align:left;text-indent:-73.25pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_1975" o:spid="_x0000_i1040" type="#_x0000_t75" style='width:241.2pt;
 height:147.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image007.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=402 height=246
src="10_SparkPerformanceOptimizationAndMalfunction.files/image008.jpg" v:shapes="Picture_x0020_1975"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-4
mapPartitions </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>算子</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>比如，当要把
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>中的所有数据通过 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>JDBC </span>写入数据，如果使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>算子，那么需要对 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>中的每一个元素都创建一个数据库连接，这样对资源的消耗很大，如果使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>mapPartitions </span>算子，那么针对一个分区的数据，只需要建立一个数据库连接。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.45pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>mapPartitions </span>算子也存在一些缺点：对于普通的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>操作，一次处理一条数据，如果在处理了 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2000
</span>条数据后内存不足，那么可以将已经处理完的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2000 </span>条数据从内存中垃圾回收掉；<span
style='color:red'>但是如果使用 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>mapPartitions </span><span
style='color:red'>算子，但数据量非常大时，</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>function </span><span
style='color:red'>一次处理一个分区的数据，如果一旦内存不足，此时无法回收内存（无法单条回收，必须全部释放），就可能会 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>OOM</span><span style='color:red'>，即内存溢出</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>因此， <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>mapPartitions </span>算子适用于数据量不是特别大的时候，此时使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>mapPartitions </span>算子对性能的提升效果还是不错的。（当数据量很大的时候，一旦使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>mapPartitions </span>算子，就会直接 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>OOM</span>）<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.15pt;margin-left:-.75pt'>在项目中，应该首先估算一下 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>的数据量、每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>partition </span>的数据量，以及分配给每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>的内存资源，如果资源允许，可以考虑使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>mapPartitions </span>算子代替 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.2.2</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
lang=EN-US>foreachPartition </span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>优化数据库操作</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>在生产环境中，通常使用 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>foreachPartition </span><span
style='color:red'>算子来完成数据库的写入，通过 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>foreachPartition
</span><span style='color:red'>算子的特性，可以优化写数据库的性能</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.75pt;margin-bottom:
.45pt;margin-left:-.75pt'>如果使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>foreach </span>算子完成数据库的操作，由于 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>foreach </span>算子是遍历 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>的每条数据，因此，每条数据都会建立一个数据库连接，这是对资源的极大浪费，因此，对于写数据库操作，我们应当使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>foreachPartition </span>算子。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>与 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>mapPartitions </span>算子非常相似，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>foreachPartition </span>是将 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>的每个分区作为遍历对象，一次处理一个分区的数据，也就是说，如果涉及数据库的相关操作，一个分区的数据只需要创建一次数据库连接（写数据的时候，<span
lang=EN-US>foreachRDD</span>与<span lang=EN-US>foreachPartition</span>一起用，前者套后者，每个分区创建一次数据库连接或者操作一次数据库，不要用<span
lang=EN-US>foreach</span>），如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-5 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.5pt;
margin-bottom:11.0pt;margin-left:155.8pt;text-align:left;text-indent:-155.8pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_2154" o:spid="_x0000_i1039" type="#_x0000_t75" style='width:420pt;
 height:45.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image009.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=700 height=76
src="10_SparkPerformanceOptimizationAndMalfunction.files/image010.jpg" v:shapes="Picture_x0020_2154"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-5
foreachPartition </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>算子</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>使用了 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>foreachPartition
</span>算子后，可以获得以下的性能提升：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:38.15pt;text-indent:-15.1pt;line-height:125%;mso-list:l1 level1 lfo1'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>对于我们写的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>function </span>函数，<span style='color:red'>一次处理一整个分区的数据</span>；<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.45pt;margin-left:38.15pt;text-indent:-15.1pt;mso-list:l1 level1 lfo1'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>对于一个分区内的数据，<span
style='color:red'>创建唯一的数据库连接</span>；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:38.15pt;text-indent:-15.1pt;line-height:125%;mso-list:l1 level1 lfo1'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>只需要向数据库发送一次 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>SQL </span><span
style='color:red'>语句和多组参数</span>；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.45pt;margin-left:-.75pt'><span style='color:red'>在生产环境中，全部都会使用 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>foreachPartition </span><span style='color:red'>算子完成数据库操作</span>。
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>foreachPartition </span>算子存在一个问题，与 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>mapPartitions
</span>算子类似，如果一个分区的数据量特别大，可能会造成 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>OOM</span>，即内存溢出。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.2.3</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
lang=EN-US>filter </span><span style='font-family:宋体;mso-bidi-font-family:宋体;
font-weight:normal'>与 </span><span lang=EN-US>coalesce </span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>的配合使用</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
3.8pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>任务中我们经常会使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>filter </span>算子完成 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>中数据的过滤，在任务初始阶段，从各个分区中加载到的数据量是相近的，但是一旦进过
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>filter </span>过滤后，每个分区的数据量有可能会存在较大差异，如图 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-6
</span>所示：<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:71.5pt;
margin-bottom:11.3pt;margin-left:157.6pt;text-align:left;text-indent:-99.55pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="_x0000_i1038" type="#_x0000_t75" style='width:297.6pt;height:155.4pt;
 visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image011.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=496 height=259
src="10_SparkPerformanceOptimizationAndMalfunction.files/image012.jpg" v:shapes="_x0000_i1038"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-6
</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>分区数据过滤结果</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>根据图 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-6
</span>我们可以发现两个问题：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l7 level1 lfo2'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>partition </span><span
style='color:red'>的数据量变小了</span>，如果还按照之前与 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>partition </span>相等的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>个数去处理当前数据，有点浪费 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>的计算资源；<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l7 level1 lfo2'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>partition </span><span
style='color:red'>的数据量不一样</span>，会导致后面的每个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>处理每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>partition </span>数据的时候，每个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>要处理的数据量不同，这很有可能导致数据倾斜问题。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-6 </span>所示，第二个分区的数据过滤后只剩 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>100 </span>条，而第三个分区的数据过滤后剩下 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>800
</span>条，在相同的处理逻辑下，第二个分区对应的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>处理的数据量与第三个分区对应的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>处理的数据量差距达到了 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>8 </span>倍，这也会导致运行速度可能存在数倍的差距，这也就是数据倾斜问题。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>针对上述的两个问题，我们分别进行分析：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.7pt;
margin-bottom:.45pt;margin-left:11.15pt;text-align:left;text-indent:11.25pt;
line-height:125%;mso-list:l6 level1 lfo3'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>针对第一个问题，既然分区的数据量变小了，我们希望可以对分区数据进行重新分配，比如将原来
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>4 </span>个分区的数据转化到 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2 </span>个分区中，这样只需要用后面的两个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>进行处理即可，避免了资源的浪费。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.7pt;
margin-bottom:.45pt;margin-left:11.15pt;text-align:left;text-indent:11.25pt;
mso-list:l6 level1 lfo3'><![if !supportLists]><span lang=EN-US
style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>针对第二个问题，解决方法和第一个问题的解决方法非常相似，对分区数据重新分配，让每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>partition </span>中的数据量差不多，这就避免了数据倾斜问题。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>那么具体应该如何实现上面的解决思路？我们需要 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>coalesce </span>算子。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>repartition </span>与 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce </span>都可以用来进行重分区，其中
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>repartition </span>只是 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce </span>接口中
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>为 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>true </span>的简易实现，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce
</span>默认情况下不进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle</span>，但是可以通过参数进行设置。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.45pt;
margin-left:23.05pt;text-indent:0cm'>假设我们希望将原本的分区个数 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>A
</span>通过重新分区变为 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>B</span>，那么有以下几种情况：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>1.</span><span
lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'> </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>A &gt; B</span>（多数分区合并为少数分区）<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:38.75pt;text-indent:-17.75pt;mso-list:l5 level1 lfo4'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%'><span
style='mso-list:Ignore'>①<span style='font:7.0pt "Times New Roman"'>&nbsp; </span></span></span><![endif]><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>A </span>与 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>B </span>相差值不大<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
2.8pt;margin-left:21.5pt;text-indent:-.5pt;line-height:107%'>此时使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>coalesce </span>即可，无需 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle </span>过程。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:38.75pt;text-indent:-17.75pt;mso-list:l5 level1 lfo4'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%'><span
style='mso-list:Ignore'>②<span style='font:7.0pt "Times New Roman"'>&nbsp; </span></span></span><![endif]><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>A </span>与 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>B </span>相差值很大<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.45pt;
margin-left:11.05pt;text-indent:9.95pt'>此时可以使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce
</span>并且不启用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>过程，但是会导致合并过程性能低下，所以推荐设置
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>coalesce </span>的第二个参数为 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>true</span>，即启动
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>过程。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2.</span><span
lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'> </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>A &lt; B</span>（少数分区分解为多数分区）<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
.15pt;margin-left:11.05pt;text-indent:9.95pt;line-height:130%'>此时使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>repartition </span>即可，如果使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce
</span>需要将 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>设置为 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>true</span>，否则
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>coalesce </span>无效。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>我们可以在 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>filter </span><span
style='color:red'>操作之后，使用 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>coalesce </span><span
style='color:red'>算子针对每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>partition </span><span
style='color:red'>的数据量各不相同的情况，压缩 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>partition
</span><span style='color:red'>的数量，而且让每个 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>partition </span><span style='color:red'>的数据量尽量均匀紧凑，以便于后面的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>进行计算操作，在某种程度上能够在一定程度上提升性能</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span lang=EN-US
style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape id="Picture_x0020_2238"
 o:spid="_x0000_i1037" type="#_x0000_t75" style='width:297.6pt;height:155.4pt;
 visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image011.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=496 height=259
src="10_SparkPerformanceOptimizationAndMalfunction.files/image012.jpg" v:shapes="Picture_x0020_2238"><![endif]></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.15pt;margin-left:-.75pt'>注意：<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>local </span>模式是进程内模拟集群运行，已经对并行度和分区数量有了一定的内部优化，因此不用去设置并行度和分区数量。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.2.4</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
lang=EN-US>repartition </span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>解决 </span><span lang=EN-US>SparkSQL </span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>低并行度问题</span>
</h3>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:.7pt;margin-left:0cm;text-align:left;text-indent:23.05pt;
line-height:122%'>在第一节的常规性能调优中我们讲解了并行度的调节策略，但是，<span style='color:#7030A0'>并行度的设置对于
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:#7030A0'>Spark SQL </span><span
style='color:#7030A0'>是不生效的，用户设置的并行度只对于 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:#7030A0'>Spark SQL </span><span style='color:#7030A0'>以外的所有</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:2.6pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
107%'><span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:#7030A0'>Spark </span><span style='color:#7030A0'>的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:#7030A0'>stage </span><span style='color:#7030A0'>生效</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.25pt;margin-bottom:
.25pt;margin-left:-.75pt;text-indent:23.05pt;line-height:127%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark SQL </span>的并行度不允许用户自己指定，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark SQL </span><span style='color:red'>自己会默认根据 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>hive </span><span style='color:red'>表（即从<span
lang=EN-US>Hive</span>读数据）对应的<b> </b></span><b><i><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>HDFS </span></i></b><b><i><span style='color:red'>文件的 </span></i></b><b><i><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>split </span></i></b><b><i><span style='color:
red'>个数</span></i></b><span style='color:red'>自动设置 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark SQL </span><span style='color:red'>所在的那个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stage </span><span style='color:red'>的并行度</span>，此时<span
style='color:red'>用户自己通 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>spark.default.parallelism </span><span
style='color:red'>参数指定的并行度无效；当<span lang=EN-US>SparkSQL</span>去直接读<span
lang=EN-US>HDFS</span>的文件时，首先根据</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>HDFS </span><span
style='color:red'>文件的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>split </span><span
style='color:red'>个数划分<span lang=EN-US>stage</span>，如果设置了</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>spark.default.parallelism</span><span
style='color:red'>，则以这个参数来划分</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>由于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark SQL </span>所在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>stage </span>的并行度无法手动设置，如果数据量较大，并且此 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>stage
</span>中后续的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>transformation </span>操作有着复杂的业务逻辑，而 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark SQL </span>自动设置的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>数量很少，这就意味着每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>要处理为数不少的数据量，然后还要执行非常复杂的处理逻辑，这就可能表现为第一个有 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark SQL </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>stage </span>速度很慢，而后续的没有 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark SQL </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>stage </span>运行速度非常快。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
3.95pt;margin-left:23.05pt;text-indent:0cm'>为了解决 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
SQL </span>无法设置并行度和 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>数量的问题，我们可以使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>repartition </span>算子。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:27.95pt;
margin-bottom:5.7pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_2653" o:spid="_x0000_i1036" type="#_x0000_t75" style='width:402.6pt;
 height:216.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image013.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=671 height=361
src="10_SparkPerformanceOptimizationAndMalfunction.files/image014.jpg" v:shapes="Picture_x0020_2653"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:7.5pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-7 repartition</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>算子使用前后对比图</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark SQL </span>这一步的并行度和 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>数量肯定是没有办法去改变了（从<span lang=EN-US>Hive</span>读无法手动指定并行度），但是，<span
style='color:red'>对于 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Spark SQL </span><span
style='color:red'>查询出来的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD</span><span
style='color:red'>，立即使用 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>repartition </span><span
style='color:red'>算子，去重新进行分区，这样可以重新分区为多个 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>partition</span><span style='color:red'>，从 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>repartition </span><span style='color:red'>之后的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>RDD </span><span style='color:red'>操作，由于不再设计 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Spark SQL</span><span style='color:red'>，因此 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stage </span><span style='color:red'>的并行度就会等于你手动设置的值</span>，这样就避免了
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark SQL </span>所在的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>stage </span>只能用少量的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>去处理大量数据并执行复杂的算法逻辑。使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>repartition
</span>算子的前后对比如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-7 </span>所示。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.2.5</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
lang=EN-US>reduceByKey </span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>本地聚合</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduceByKey </span>相较于普通的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>操作一个显著的特点就是会进行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>端的本地聚合<span style='color:red'>，</span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>map
</span><span style='color:red'>端会先对本地的数据进行 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>combine </span><span style='color:red'>操作，然后将数据写入给下个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stage </span><span style='color:red'>的每个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>创建的文件中</span>，也就是在
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>端，对每一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>对应的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>value</span>，执行
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduceByKey </span>算子函数。<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey
</span>算子的执行过程如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-8 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.5pt;
margin-bottom:11.0pt;margin-left:142.0pt;text-align:left;text-indent:-137.1pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_2795" o:spid="_x0000_i1035" type="#_x0000_t75" style='width:405.6pt;
 height:242.4pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image015.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=676 height=404
src="10_SparkPerformanceOptimizationAndMalfunction.files/image016.jpg" v:shapes="Picture_x0020_2795"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-8
reduceByKey </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>算子执行过程</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey
</span>对性能的提升如下：<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:41.05pt;text-indent:-18.0pt;mso-list:l3 level1 lfo5'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>本地聚合<span
lang=EN-US>(map</span>端聚合<span lang=EN-US>)</span>后，在 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>端的数据量变少，减少了磁盘 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>IO</span>，也减少了对磁盘空间的占用；<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:41.05pt;text-indent:-18.0pt;mso-list:l3 level1 lfo5'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>本地聚合后，下一个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>stage </span>拉取的数据量变少，减少了网络传输的数据量；<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:41.05pt;text-indent:-18.0pt;mso-list:l3 level1 lfo5'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>本地聚合后，在
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce </span>端进行数据缓存的内存占用减少；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:41.05pt;text-indent:-18.0pt;mso-list:l3 level1 lfo5'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>本地聚合后，在
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce </span>端进行聚合的数据量减少。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
3.3pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'>基于 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduceByKey </span>的本地聚合特征，我们应该考虑使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey
</span>代替其他的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>算子，例如 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>groupByKey(</span>不聚合，直接<span lang=EN-US>Shuffle</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>)</span>。<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduceByKey </span>与 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>groupByKey </span>的运行原理如图 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-9 </span>和图
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-10 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:100.6pt;
margin-bottom:11.0pt;margin-left:160.35pt;text-align:left;text-indent:-73.25pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_2887" o:spid="_x0000_i1034" type="#_x0000_t75" style='width:239.4pt;
 height:175.2pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image017.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=399 height=292
src="10_SparkPerformanceOptimizationAndMalfunction.files/image018.jpg" v:shapes="Picture_x0020_2887"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-9
groupByKey </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>原理</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.65pt;
margin-bottom:11.0pt;margin-left:157.85pt;text-align:left;text-indent:-95.95pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_2928" o:spid="_x0000_i1033" type="#_x0000_t75" style='width:291.6pt;
 height:171.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image019.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=486 height=286
src="10_SparkPerformanceOptimizationAndMalfunction.files/image020.jpg" v:shapes="Picture_x0020_2928"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-10
reduceByKey </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>原理</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
20.3pt;margin-left:-.75pt'>根据上图可知，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>groupByKey </span>不会进行 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>端的聚合，而是将所有 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map </span>端的数据
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>到 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端，然后在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce </span>端进行数据的聚合操作。由于 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey
</span>有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>端聚合的特性，使得网络传输的数据量减小，因此效率要明显高于
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>groupByKey</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:23.25pt;margin-left:
-.25pt'><span lang=EN-US>1.3 Shuffle </span><span style='font-family:黑体;
mso-bidi-font-family:黑体;font-weight:normal'>调优</span> </h2>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.3.1</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>调节 </span><span
lang=EN-US>map </span><span style='font-family:宋体;mso-bidi-font-family:宋体;
font-weight:normal'>端缓冲区大小</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>任务运行过程中，如果 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>端处理的数据量比较大，但是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>端缓冲的大小是固定的，可能会出现 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>端缓冲数据频繁 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>spill </span>溢写到磁盘文件中的情况，使得性能非常低下，<span
style='color:red'>通过调节 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>map </span><span
style='color:red'>端缓冲的大小，可以避免频繁的磁盘</span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>IO
</span><span style='color:red'>操作，进而提升 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark </span><span style='color:red'>任务的整体性能</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>端缓冲的默认配置是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>32KB</span>，如果每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>处理 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>640KB
</span>的数据，那么会发生 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>640/32 = 20 </span>次溢写，如果每个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>处理 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>64000KB </span>的数据，机会发生 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>64000/32=2000 </span>此溢写，这对于性能的影响是非常严重的。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.05pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map </span>端缓冲的配置方法如代码清单
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-7 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-7 map</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>端缓冲配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.file.buffer</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;64&quot;) </span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;
font-family:"Courier New";mso-fareast-font-family:"Courier New";color:#538135;
mso-themecolor:accent6;mso-themeshade:191'>// </span><span style='font-size:
8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;color:#538135;mso-themecolor:
accent6;mso-themeshade:191'>翻倍调节，太大会导致<span lang=EN-US>Executor</span>内存溢出</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.3.2</span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>调节 </span><span
lang=EN-US>reduce </span><span style='font-family:宋体;mso-bidi-font-family:宋体;
font-weight:normal'>端拉取数据缓冲区大小</span> </h3>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:3.1pt;
margin-bottom:.3pt;margin-left:-.75pt;text-align:left'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
Shuffle </span>过程中，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:#7030A0'>shuffle reduce task </span><span
style='color:#7030A0'>的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:#7030A0'>buffer </span><span
style='color:#7030A0'>缓冲区大小决定了 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:#7030A0'>reduce task </span><span
style='color:#7030A0'>每次能够缓冲的数据量，也就是每次能够拉取的数据量</span>，<span style='color:red'>如果内存资源较为充足，适当增加拉取数据缓冲区的大小，可以减少拉取数据的次数，也就可以减少网络传输的次数，进而提升性能</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span>一边拉取另一边聚合的，同样是占用<span lang=EN-US>Executor</span>的内存。</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
5.6pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端数据拉取缓冲区的大小可以通过 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.reducer.maxSizeInFlight </span>参数进行设置，默认为 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>48MB</span>，该参数的设置方法如代码清单 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-8 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.35pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-8 reduce</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>端数据拉取缓冲区配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.reducer.maxSizeInFlight</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;96&quot;) </span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.3.3</span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>调节 </span><span
lang=EN-US>reduce </span><span style='font-family:宋体;mso-bidi-font-family:宋体;
font-weight:normal'>端拉取数据重试次数</span> </h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.45pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark Shuffle </span>过程中，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce task </span>拉取属于自己的数据时，如果因为网络异常等原因导致失败会自动进行重试。<span
style='color:red'>对于那些包含了特别耗时的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle </span><span
style='color:red'>操作的作业，建议增加重试最大次数（比如 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>6</span><span
style='color:red'>次），以避免由于 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>JVM </span><span
style='color:red'>的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>full gc </span><span
style='color:red'>或者网络不稳定等因素导致的数据拉取失败</span>。在实践中发现，对于针对超大数据量（数十亿<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>~</span>上百亿）的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>过程，调节该参数可以大幅度提升稳定性。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:19.55pt;
margin-bottom:2.55pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端拉取数据重试次数可以通过 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.shuffle.io.maxRetries </span>参数进行设置，</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
5.85pt;margin-left:-.75pt;text-indent:0cm'>该参数就代表了可以重试的最大次数。如果在指定次数之内拉取还是没有成功，就可能会导致作业执行失败，默认为
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3</span>，该参数的设置方法如代码清单 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-9 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-9 reduce</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>端拉取数据重试次数配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.io.maxRetries</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;6&quot;) </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:13.6pt;margin-left:
-.25pt'><span lang=EN-US>1.3.4</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>调节 </span><span lang=EN-US>reduce </span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>端拉取数据等待间隔</span>
</h3>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:4.65pt;margin-left:-.75pt;text-align:left;line-height:125%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark Shuffle </span>过程中，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
task </span>拉取属于自己的数据时，如果因为网络异常等原因导致失败会自动进行重试，在一次失败后，会等待一定的时间间隔再进行重试，可以通过加大间隔时长（比如
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>60s</span>），以增加 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>操作的稳定性。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:24.6pt;
margin-bottom:2.55pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端拉取数据等待间隔可以通过 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.shuffle.io.retryWait </span>参数进行设置，</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.25pt;margin-left:-.75pt;text-indent:0cm'>默认值为 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>5s</span>，该参数的设置方法如代码清单
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-10 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-10 reduce</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>端拉取数据等待间隔配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.io.retryWait</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;60s&quot;) //
</span><span style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%'>根据情况</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.3.5</span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>调节 </span><span
lang=EN-US>SortShuffle </span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>排序操作阈值</span> </h3>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:3.1pt;
margin-bottom:.3pt;margin-left:-.75pt;text-align:left'>对于 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>SortShuffleManager</span>，<span
style='color:red'>如果 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle reduce task </span><span
style='color:red'>的数量小于某一阈值则 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle write </span><span
style='color:red'>过程中不会进行排序操作，而是直接按照未经优化的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>HashShuffleManager </span><span style='color:red'>的方式去写数据，但是最后会将每个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>产生的所有临时磁盘文件都合并成一个文件，并会创建单独的索引文件</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.45pt;
margin-left:-.75pt'>当你使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>SortShuffleManager </span>时，如果的确不需要排序操作，那么建议将这个参数调大一些，大于
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle read task </span>的数量，那么此时 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map-side
</span>就不会进行排序了，减少了排序的性能开销，但是这种方式下，依然会产生大量的磁盘文件，因此 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
write </span>性能有待提高。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
4.85pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>SortShuffleManager </span>排序操作阈值的设置可以通过 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>spark.shuffle.sort.
bypassMergeThreshold </span>这一参数进行设置，默认值为 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>200</span>，该参数的设置方法如代码清单
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2-11 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-10 reduce</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>端拉取数据等待间隔配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.sort.bypassMergeThreshold</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;400&quot;) </span></p>

<h2 style='margin-left:-.25pt'><span lang=EN-US>1.4 JVM </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>调优</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.25pt;margin-bottom:
20.8pt;margin-left:-.75pt;text-indent:23.05pt;line-height:127%'>对于 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>JVM </span>调优，首先应该明确，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>full
gc/minor gc</span><span style='color:red'>，都会导致 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>JVM </span><span style='color:red'>的工作线程停止工作</span>，即 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stop the world</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.3pt;margin-left:
-.25pt'><span lang=EN-US>1.4.1</span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>降低 </span><span lang=EN-US>cache </span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>操作的内存占比</span>
</h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.45pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:21.95pt;line-height:130%'><span
lang=EN-US style='font-size:11.0pt;line-height:130%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>1.<span style='mso-spacerun:yes'>  </span></span><span
style='font-size:11.0pt;line-height:130%;font-family:黑体;mso-bidi-font-family:
黑体'>静态内存管理机制（<span lang=EN-US>1.6</span>版本以前）<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.45pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:21.95pt;line-height:130%'>根据 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>静态内存管理机制，堆内存被划分为了两块，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Storage
</span>和 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution</span>。 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Storage
</span>主要用于缓存 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>数据和 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>broadcast
</span>数据，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution </span>主要用于缓存在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>过程中产生的中间数据，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Storage </span>占系统内存的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>60%</span>，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution </span>占系统内存的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>20%</span>，并且两者完全独立。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在一般情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Storage </span>的内存都提供给了 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>cache </span>操作，但是如果在某些情况下 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>cache
</span>操作内存不是很紧张，而 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>的算子中创建的对象很多，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Execution </span>内存又相对较小，这回导致频繁的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>minor
gc</span>，甚至于频繁的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>full gc</span>，进而导致 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>频繁的停止工作，性能影响会很大。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark UI </span>中可以查看每个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>stage </span>的运行情况，包括每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>的运行时间、<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>gc </span>时间等等，<span
style='color:red'>如果发现 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>gc </span><span
style='color:red'>太频繁，时间太长，就可以考虑调节 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>Storage
</span><span style='color:red'>的内存占比，让 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>task </span><span style='color:red'>执行算子函数式，有更多的内存可以使用</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:24.6pt;
margin-bottom:2.55pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Storage </span>内存区域可以通过 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark.storage.memoryFraction </span>参数进行指定，默认为</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.1pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>0.6</span>，即
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>60%</span>，可以逐级向下递减，如代码清单 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-6 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-6 Storage</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>内存占比设置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:12.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.storage.memoryFraction</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;0.4&quot;) </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
24.4pt;margin-left:-.75pt'><span lang=EN-US style='font-size:11.0pt;line-height:
125%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2.<span
style='mso-spacerun:yes'>  </span></span><span style='font-size:11.0pt;
line-height:125%;font-family:黑体;mso-bidi-font-family:黑体'>统一内存管理机制（<span
lang=EN-US>1.6</span>版本以后）<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
24.4pt;margin-left:-.75pt'>根据 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>统一内存管理机制，堆内存被划分为了两块，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Storage </span>和 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution</span>。 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Storage
</span>主要用于缓存数据，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution </span>主要用于缓存在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>过程中产生的中间数据，两者所组成的内存部分称为统一内存，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Storage
</span>和 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Execution </span>各占统一内存的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>50%</span>，由于动态占用机制的实现，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>shuffle
</span><span style='color:red'>过程需要的内存过大时，会自动占用 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Storage </span><span style='color:red'>的内存区域，因此无需手动进行调节</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3 style='margin-left:-.25pt'><span lang=EN-US>1.4.2</span><span
style='font-family:宋体;mso-bidi-font-family:宋体;font-weight:normal'>调节 </span><span
lang=EN-US>Executor </span><span style='font-family:宋体;mso-bidi-font-family:
宋体;font-weight:normal'>堆外内存</span><span lang=EN-US><span
style='mso-spacerun:yes'>  </span></span></h3>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:25.3pt;
margin-bottom:2.65pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
style='color:red'>的堆外内存主要用于程序的共享库、</span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>Perm
Space</span><span style='color:red'>、</span><span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'> </span><span
style='color:red'>线程 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Stack </span><span
style='color:red'>和一些</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.25pt;margin-bottom:
.25pt;margin-left:-.25pt;text-indent:-.5pt;line-height:127%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Memory mapping </span><span style='color:red'>等</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>, </span><span style='color:red'>或者类 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>C </span><span style='color:red'>方式 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>allocate object</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>有时，如果你的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业处理的数据量非常大，达到几亿的数据量，此时运行
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业会时不时地报错，例如 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>shuffle
output file cannot find</span><span style='color:red'>，</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>executor lost</span><span style='color:red'>，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task lost</span><span style='color:red'>，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>out of memory </span>等，这可能是 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>的堆外内存不太够用，导致 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>在运行的过程中内存溢出。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>stage </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>在运行的时候，可能要从一些 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Executor </span>中去拉取 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
map output </span>文件，但是 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>可能已经由于内存溢出挂掉了，其关联的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>也没有了，这就可能会报出 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
output file cannot find</span>，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>executor lost</span>，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task lost</span>，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>out of memory </span>等错误，此时，就可以考虑调节一下
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Executor </span>的堆外内存，也就可以避免报错，与此同时，堆外内存调节的比较大的时候，对于性能来讲，也会带来一定的提升。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.65pt;margin-bottom:
.45pt;margin-left:-.75pt'>默认情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>堆外内存上限大概为 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>300 </span>多 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>MB</span>，在实际的生产环境下，对海量数据进行处理的时候，这里都会出现问题，导致
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业反复崩溃，无法运行，此时就会去调节这个参数，到至少 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>1G</span>，甚至于
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>2G</span>、<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>4G</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:18.7pt;
margin-bottom:7.5pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:110%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>堆外内存的配置需要在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark-submit </span>脚本里配置，如代码清单 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>2-7
</span>所示：<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.55pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-7 Executor</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>堆外内存配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.1pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--conf </span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New";color:#00B0F0'>spark.yarn.executor.memoryOverhead</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;
font-family:"Courier New";mso-fareast-font-family:"Courier New"'>=2048 </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.2pt;margin-left:-.75pt'>以上参数配置完成后，会避免掉某些 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>JVM OOM </span>的异常问题，同时，可以提升整体
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的性能。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3><span lang=EN-US>1.4.3</span><span style='font-family:宋体;mso-bidi-font-family:
宋体'>调节连接等待时长</span><span lang=EN-US><span style='mso-spacerun:yes'>  </span></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'>在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业运行过程中，<span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor </span>优先从自己本地关联的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>BlockManager </span>中获取某份数据，如果本地 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>BlockManager
</span>没有的话，会通过 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>TransferService </span>远程连接其他节点上 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Executor </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>BlockManager </span>来获取数据。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.65pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>如果 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>在运行过程中创建大量对象或者创建的对象较大，会占用大量的内存，这回导致频繁的垃圾回收，但是<span
style='color:red'>垃圾回收会导致工作现场全部停止，也就是说，垃圾回收一旦执行，</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark </span><span style='color:red'>的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Executor </span><span style='color:red'>进程就会停止工作，无法提供相应，此时，由于没有响应，无法建立网络连接，会导致网络连接超时</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
3.0pt;margin-left:-.75pt'>在生产环境下，有时会遇到 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>file
not found</span><span style='color:red'>、</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>file lost </span>这类错误，在这种情况下，很有可能是 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>BlockManager </span>在拉取数据的时候，无法建立连接，然后超过默认的连接等待时长
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>60s </span>后，宣告数据拉取失败，如果反复尝试都拉取不到数据，可能会导致 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span>作业的崩溃。这种情况也可能会导致 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>DAGScheduler </span>反复提交几次 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>stage</span>，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>TaskScheduler </span>返回提交几次 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task</span>，大大延长了我们的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>作业的运行时间。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
5.5pt;margin-left:-.75pt'>此时，可以考虑调节连接的超时时长，连接等待时长需要在 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>spark-submit
</span>脚本中进行设置，设置方式如代码清单 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>2-8 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>2-8 </span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>连接等待时长配置</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.1pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--conf </span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New";color:#00B0F0'>spark.core.connection.ack.wait.timeout</span><span
lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;
font-family:"Courier New";mso-fareast-font-family:"Courier New"'>=300 </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
30.55pt;margin-left:-.75pt'>调节连接等待时长后，通常可以避免部分的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>XX
</span>文件拉取失败、<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>XX </span>文件 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>lost
</span>等报错。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<h1 style='margin-top:0cm;margin-right:0cm;margin-bottom:11.4pt;margin-left:
-.25pt'>第二章 <b style='mso-bidi-font-weight:normal'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span></b>数据倾斜<b style='mso-bidi-font-weight:normal'><span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></b></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark </span><span style='color:red'>中的数据倾斜问题主要指 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>shuffle </span><span style='color:red'>过程中出现的数据倾斜问题，是由于不同的
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>对应的数据量不同导致的不同 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>task
</span><span style='color:red'>所处理的数据量不同的问题</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.65pt;margin-bottom:
.45pt;margin-left:-.75pt'>例如，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>点一共要处理 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>100 </span>万条数据，第一个和第二个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>分别被分配到了
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>1 </span>万条数据，计算 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>5 </span>分钟内完成，第三个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>分配到了 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>98 </span>万数据，此时第三个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>可能需要 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>个小时完成，这使得整个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业需要 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>个小时才能运行完成，这就是数据倾斜所带来的后果。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>注意，要区分开数据倾斜与数据量过量这两种情况，数据倾斜是指少数 </span><b style='mso-bidi-font-weight:
normal'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span></b><span
style='color:red'>被分配了绝大多数的数据，因此少数 </span><b style='mso-bidi-font-weight:normal'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span></b><span style='color:red'>运行缓慢；数据过量是指所有
</span><b style='mso-bidi-font-weight:normal'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>task </span></b><span style='color:red'>被分配的数据量都很大，相差不多，所有 </span><b
style='mso-bidi-font-weight:normal'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span></b><span
style='color:red'>都运行缓慢。</span><b style='mso-bidi-font-weight:normal'><span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'> </span></b></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.15pt;text-indent:0cm'><b>数据倾斜的表现：</b><b><span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span><span lang=EN-US><o:p></o:p></span></b></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.4pt;
margin-bottom:.45pt;margin-left:0cm;text-align:left;mso-list:l0 level1 lfo6'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的大部分 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>都执行迅速，只有有限的几个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>执行的非常慢，此时可能出现了数据倾斜，作业可以运行，但是运行得非常慢；<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.4pt;
margin-bottom:.45pt;margin-left:0cm;text-align:left;line-height:125%;
mso-list:l0 level1 lfo6'><![if !supportLists]><span lang=EN-US
style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的大部分 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task </span>都执行迅速，但是有的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>在运行过程中会突然报出 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>OOM</span>，反复执行几次都在某一个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>报出 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>OOM </span>错误，此时可能出现了数据倾斜，作业无法正常运行。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.15pt;text-indent:0cm'><b>定位数据倾斜问题：</b><b><span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span><span lang=EN-US><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:13.25pt;margin-bottom:
.15pt;margin-left:0cm;text-indent:22.8pt;line-height:130%;mso-list:l11 level1 lfo7'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:130%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>查阅代码中的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>算子，例如 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey</span>、<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>countByKey</span>、<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>groupByKey</span>、 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join
</span>等算子，根据代码逻辑判断此处是否会出现数据倾斜；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:13.25pt;margin-bottom:
21.4pt;margin-left:0cm;text-indent:22.8pt;mso-list:l11 level1 lfo7'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>查看
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>log </span>文件，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>log
</span>文件对于错误的记录会精确到代码的某一行，可以根据异常定位到的代码位置来明确错误发生在第几个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>stage</span>，对应的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>算子是哪一个；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:13.25pt;margin-bottom:
21.4pt;margin-left:0cm;text-indent:22.8pt;mso-list:l11 level1 lfo7'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>对数据进行抽样（<span
lang=EN-US style='mso-bidi-font-size:14.0pt;line-height:125%;font-family:"Times New Roman","serif"'>sample</span>），然后<span
lang=EN-US style='mso-bidi-font-size:14.0pt;line-height:125%;font-family:"Times New Roman","serif"'>countByKey</span><span
style='mso-bidi-font-size:14.0pt;line-height:125%;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";mso-bidi-font-family:"Times New Roman"'>看一下</span><span
lang=EN-US style='mso-bidi-font-size:14.0pt;line-height:125%;font-family:"Times New Roman","serif"'>key</span><span
style='mso-bidi-font-size:14.0pt;line-height:125%;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman";mso-bidi-font-family:"Times New Roman"'>的比例，结合分区</span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.45pt;margin-left:
-.25pt'><span lang=EN-US>2.1 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>解决方案一：聚合原数据</span> </h2>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>1. </span><span
style='font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>避免 </span><span lang=EN-US style='font-size:11.0pt;
line-height:107%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial;
font-weight:normal'>shuffle </span><span style='font-size:11.0pt;line-height:
107%;font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>过程</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>绝大多数情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业的数据来源都是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Hive </span>表，这些 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Hive </span>表基本都是经过 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>ETL </span>之后的昨天的数据。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.2pt;
margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>为了避免数据倾斜，我们可以考虑避免 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>shuffle
</span><span style='color:red'>过程，如果避免了 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>shuffle </span><span style='color:red'>过程，那么从根本上就消除了发生数据倾斜问题的可能</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>如果 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业的数据来源于 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Hive </span>表，那么可以先在 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Hive </span>表中对数据进行聚合，例如按照
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>进行分组，将同一 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key </span>对应的所有
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>value </span>用一种特殊的格式拼接到一个字符串里去，这样，一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>就只有一条数据了；之后，对一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>的所有 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>value
</span>进行处理时，只需要进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>操作即可，无需再进行任何的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>操作。通过上述方式就避免了执行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
</span>操作，也就不可能会发生任何的数据倾斜问题。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>对于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Hive </span>表中数据的操作，不一定是拼接成一个字符串，也可以是直接对
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>的每一条数据进行累计计算。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
7.15pt;margin-left:23.15pt;text-indent:0cm;line-height:125%'><span
style='color:red'>要区分开，处理的数据量大和数据倾斜的区别</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>2. </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>缩小</span><span lang=EN-US
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> key </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>粒度（增大数据倾斜可能性，降低每个</span><span
lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> task </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>的数据量）<span lang=EN-US><o:p></o:p></span></span></h3>

<p class=MsoNormal><span lang=EN-US><span style='mso-spacerun:yes'> </span>key </span>的数量增加，可能使数据倾斜更严重。
</p>

<h3><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'>3. </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>增大</span><span lang=EN-US
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> key </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>粒度（减小数据倾斜可能性，增大每个</span><span
lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> task </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>的数据量）</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> <span lang=EN-US><o:p></o:p></span></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>如果没有办法对每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>聚合出来一条数据，在特定场景下，可以考虑扩大 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>的聚合粒度。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:21.5pt;margin-bottom:
21.55pt;margin-left:-.75pt'>例如，目前有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>万条用户数据，当前 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>的粒度是（省，城市，区，日期），现在我们考虑扩大粒度，将 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>的粒度扩大为（省，城市，日期），这样的话，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>的数量会减少，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>之间的数据量差异也有可能会减少，由此可以减轻数据倾斜的现象和问题。（此方法只针对特定类型的数据有效，当应用场景不适宜时，会加重数据倾斜）<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.45pt;margin-left:
-.25pt'><span lang=EN-US>2.2 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>解决方案二：过滤导致倾斜的 </span><span lang=EN-US>key </span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.25pt;margin-left:-.75pt'>如果在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业中允许丢弃某些数据，那么<span
style='color:red'>可以考虑将可能导致数据倾斜的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>key
</span><span style='color:red'>进行过滤，滤除可能导致数据倾斜的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>key </span><span style='color:red'>对应的数据</span>，这样，在 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业中就不会发生数据倾斜了。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h2 style='margin-left:-.25pt'><span lang=EN-US>2.3 </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>解决方案三：提高 </span><span
lang=EN-US>shuffle </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>操作中的 </span><span lang=EN-US>reduce </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>并行度</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.6pt;margin-left:-.75pt'>当方案一和方案二对于数据倾斜的处理没有很好的效果时，可以考虑提高 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
</span>过程中的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端并行度，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
</span>端并行度的提高就增加了 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>的数量，那么每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>分配到的数据量就会相应减少，由此缓解数据倾斜问题。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>1.
reduce </span><span style='font-size:11.0pt;line-height:107%;font-family:黑体;
mso-bidi-font-family:黑体;font-weight:normal'>端并行度的设置</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
.15pt;margin-left:-.75pt;text-indent:23.05pt;line-height:130%'>在大部分的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>算子中，都可以传入一个并行度的设置参数，比如 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey(500)</span>，<span
style='color:red'>这个参数会决定 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle </span><span
style='color:red'>过程中 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>reduce </span><span
style='color:red'>端的并行度，在进行 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle </span><span
style='color:red'>操作的时候，就会对应着创建指定数量的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>reduce
task</span>。对于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark SQL </span>中的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.45pt;
margin-left:-.75pt;text-indent:0cm'>类语句，比如 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>group by</span>、<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>等，需要设置一个参数，即 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>spark.sql.shuffle.partitions</span>，该参数代表了
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle read task </span>的并行度，该值默认是 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>200</span>，对于很多场景来说都有点过小。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.8pt;margin-bottom:
6.45pt;margin-left:-.75pt'><span style='color:red'>增加 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>shuffle read task </span><span style='color:red'>的数量，可以让原本分配给一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>的多个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>key </span><span style='color:red'>分配给多个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task</span><span style='color:red'>，从而让每个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>处理比原来更少的数据</span>。举例来说，如果原本有
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>5 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key</span>，每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>对应 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>条数据，这 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>5
</span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>都是分配给一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>的，那么这个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>就要处理 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>50
</span>条数据。而增加了 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle read task </span>以后，每个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>就分配到一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key</span>，即每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>就处理 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>条数据，那么自然每个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>的执行时间都会变短了。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.3pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>2. reduce
</span><span style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>端并行度设置存在的缺陷</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> <span lang=EN-US><o:p></o:p></span></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>提高 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端并行度并没有从根本上改变数据倾斜的本质和问题（方案一和方案二从根本上避免了数据倾斜的发生），只是尽可能地去缓解和减轻
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle reduce task </span>的数据压力，以及数据倾斜的问题，<span
style='color:red'>适用于有较多 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>对应的数据量都比较大的情况</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:3.1pt;
margin-bottom:.3pt;margin-left:-.75pt;text-align:left'><span style='color:red'>该方案通常无法彻底解决数据倾斜，因为如果出现一些极端情况，比如某个
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>对应的数据量有 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>100 </span><span
style='color:red'>万，那么无论你的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>数量增加到多少，这个对应着 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>100
</span><span style='color:red'>万数据的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>key
</span><span style='color:red'>肯定还是会分配到一个 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>task </span><span style='color:red'>中去处理，因此注定还是会发生数据倾斜的</span>。所以这种方案只能说是在发现数据倾斜时尝试使用的第一种手段，尝试去用嘴简单的方法缓解数据倾斜而已，或者是和其他方案结合起来使用。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.55pt;margin-bottom:
21.6pt;margin-left:-.75pt'>在理想情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端并行度提升后，会在一定程度上减轻数据倾斜的问题，甚至基本消除数据倾斜；但是，在一些情况下，只会让原来由于数据倾斜而运行缓慢的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>task </span>运行速度稍有提升，或者避免了某些 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>OOM </span>问题，但是，仍然运行缓慢，此时，要及时放弃方案三，开始尝试后面的方案。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>2.4 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>解决方案四：使用随机 </span><span lang=EN-US>key </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>实现双重聚合</span>
</h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当使用了类似于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>groupByKey</span>、<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduceByKey
</span>这样的算子时，可以考虑使用随机 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>实现双重聚合，如图 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3-1 </span>所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:99.05pt;
margin-bottom:11.3pt;margin-left:149.1pt;text-align:left;text-indent:-62.95pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_4630" o:spid="_x0000_i1032" type="#_x0000_t75" style='width:243pt;
 height:342.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image021.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=405 height=571
src="10_SparkPerformanceOptimizationAndMalfunction.files/image022.jpg" v:shapes="Picture_x0020_4630"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>3-1
</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>随机
</span><span lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%'>实现双重聚合</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.7pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>首先，<span
style='color:red'>通过 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>map </span><span
style='color:red'>算子给每个数据的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>添加随机数前缀，对 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>进行打散，将原先一样的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>变成不一样的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key</span><span
style='color:red'>，然后进行第一次聚合</span>，<span style='color:red'>这样就可以让原本被一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>处理的数据分散到多个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>上去做局部聚合</span>；随后，<span
style='color:red'>去除掉每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>的前缀，再次进行聚合，就可以避免数据倾斜</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:3.1pt;
margin-bottom:.3pt;margin-left:-.75pt;text-align:left'>此方法对于由 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>groupByKey</span>、<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduceByKey </span>这类算子造成的数据倾斜由比较好的效果，<span
style='color:red'>仅仅适用于聚合类的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle </span><span
style='color:red'>操作，适用范围相对较窄。如果是 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>join
</span><span style='color:red'>类的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>shuffle
</span><span style='color:red'>操作，还得用其他的解决方案</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal>此方法也是前几种方案没有比较好的效果时要尝试的解决方案。 （类似于<span lang=EN-US>HBase</span>的<span
lang=EN-US>RowKey</span>的设计）</p>

<h2 style='margin-left:-.25pt'><span lang=EN-US>2.5 </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>解决方案五：将 </span><span
lang=EN-US>reduce join </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>转换为 </span><span lang=EN-US>map join </span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.45pt;
margin-left:-.75pt'>正常情况下，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>操作都会执行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
</span>过程，并且执行的是 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce join</span>，也就是先将所有相同的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>和对应的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>value </span>汇聚到一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
task </span>中，然后再进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join</span>。</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'>普通 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join </span>的过程如下图所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:104.8pt;margin-bottom:
2.5pt;margin-left:159.65pt;text-indent:-66.05pt;line-height:130%'><span
lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape id="Picture_x0020_4772"
 o:spid="_x0000_i1031" type="#_x0000_t75" style='width:228pt;height:180pt;
 visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image023.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=380 height=300
src="10_SparkPerformanceOptimizationAndMalfunction.files/image024.jpg" v:shapes="Picture_x0020_4772"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span>图 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3-2 </span>普通 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>过程<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'>普通的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>是会走 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>shuffle </span>过程的，而一旦 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle</span>，就相当于会将相同 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key </span>的数据拉取到一个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle read task </span>中再进行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join</span>，此时就是
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce join</span>。但是如果一个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>是比较小的，则可以采用<span
style='color:red'>广播小 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>全量数据</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>+map </span><span
style='color:red'>算子</span>来实现与 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>同样的效果，也就是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map join</span>，此时就不会发生 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle </span>操作，也就不会发生数据倾斜。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
6.45pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>（<span
style='color:red'>注意，</span><b style='mso-bidi-font-weight:normal'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>RDD </span></b><span style='color:red'>是并不能进行广播的，只能将
</span><b style='mso-bidi-font-weight:normal'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>RDD </span></b><span style='color:red'>内部的数据通过 </span><b
style='mso-bidi-font-weight:normal'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>collect </span></b><span
style='color:red'>拉取到 </span><b style='mso-bidi-font-weight:normal'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Driver </span></b><span style='color:red'>内存然后再进行广播</span>）<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span>不广播会有多个副本。</p>

<h3 style='margin-top:0cm;margin-right:67.05pt;margin-bottom:5.35pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>1. </span><span
style='font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>核心思路：</span><span style='font-size:11.0pt;line-height:
107%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:
normal'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>不使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>算子进行连接操作，而使用 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Broadcast </span>变量与
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>类算子实现 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>操作，进而完全规避掉 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle </span>类的操作，彻底避免数据倾斜的发生和出现。<span style='color:red'>将较小
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>中的数据直接通过 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>collect </span><span
style='color:red'>算子拉取到 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Driver </span><span
style='color:red'>端的内存中来，然后对其创建一个 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>Broadcast
</span><span style='color:red'>变量</span>；接着对另外一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>执行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>map </span>类算子，<span
style='color:red'>在算子函数内，从 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Broadcast </span><span
style='color:red'>变量中获取较小 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>的全量数据，与当前 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>的每一条数据按照连接 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>进行比对，如果连接 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>相同的话，那么就将两个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>的数据用你需要的方式连接起来</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>根据上述思路，根本不会发生 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle </span>操作，从根本上杜绝了
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>操作可能导致的数据倾斜问题。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>操作有数据倾斜问题并且其中一个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>的数据量较小时，可以优先考虑这种方式，效果非常好。<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
join </span>的过程如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>3-3 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:106.85pt;margin-bottom:
5.55pt;margin-left:162.55pt;text-indent:-66.9pt;line-height:130%'><span
lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape id="Picture_x0020_4932"
 o:spid="_x0000_i1030" type="#_x0000_t75" style='width:223.8pt;height:178.8pt;
 visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image025.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=373 height=298
src="10_SparkPerformanceOptimizationAndMalfunction.files/image026.jpg" v:shapes="Picture_x0020_4932"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span>图 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3-3 map join </span>过程<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:67.05pt;margin-bottom:5.35pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>2. </span><span
style='font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>不适用场景分析：</span><span style='font-size:11.0pt;line-height:
107%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:
normal'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
21.3pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>由于 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Spark </span><span
style='color:red'>的广播变量是在每个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
style='color:red'>中保存一个副本，如果两个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>数据量都比较大，那么如果将一个数据量比较大的</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'> RDD </span><span style='color:red'>做成广播变量，那么很有可能会造成内存溢出</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2 style='margin-left:-.25pt'><span lang=EN-US>2.6 </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>解决方案六：</span><span
lang=EN-US>sample </span><span style='font-family:黑体;mso-bidi-font-family:黑体;
font-weight:normal'>采样对倾斜 </span><span lang=EN-US>key </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>单独进行 </span><span
lang=EN-US>join </span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span
style='color:red'>在 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Spark </span><span
style='color:red'>中，如果某个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>只有一个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key</span><span
style='color:red'>，那么在 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>shuffle </span><span
style='color:red'>过程中会默认将此 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>对应的数据打散，由不同的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>reduce </span><span
style='color:red'>端 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>进行处理</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.45pt;margin-bottom:
3.55pt;margin-left:-.75pt'>当<span style='color:red'>由单个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>key </span><span style='color:red'>导致数据倾斜</span>时，可有将发生数据倾斜的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>单独提取出来，组成一个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD</span>，然后用这个原本会导致倾斜的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>组成的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>根其他 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>单独 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join</span>，此时，根据 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark
</span>的运行机制，此 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>中的数据会在 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>shuffle
</span>阶段被分散到多个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>中去进行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join
</span>操作。倾斜 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>单独 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join
</span>的流程如图 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>3-4 </span>所示：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.5pt;
margin-bottom:11.0pt;margin-left:148.85pt;text-align:left;text-indent:-147.05pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_5042" o:spid="_x0000_i1029" type="#_x0000_t75" style='width:411.6pt;
 height:75.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image027.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=686 height=126
src="10_SparkPerformanceOptimizationAndMalfunction.files/image028.jpg" v:shapes="Picture_x0020_5042"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>3-4
</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>倾斜
</span><span lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%'>单独 </span><span lang=EN-US style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:104%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span><span style='font-size:
9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>流程</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:67.05pt;margin-bottom:5.35pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>1</span><span
style='font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>．</span><span style='font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:
normal'> </span><span style='font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体;font-weight:normal'>适用场景分析：</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:20.95pt;margin-bottom:
.45pt;margin-left:-.75pt'>对于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>中的数据，可以将其转换为一个中间表，或者是直接使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>countByKey() </span>的方式，看一个这个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>中各个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>对应的数据量，此时<span
style='color:red'>如果你发现整个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>就一个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>的数据量特别多，那么就可以考虑使用这种方法</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span>（如果就一个任务很慢，一个<span
lang=EN-US>key</span>倾斜的可能性大）</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当数据量非常大时，可以考虑使用 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>sample </span>采样获取
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>10%</span>的数据，然后分析这 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>10%</span>的数据中哪个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>可能会导致数据倾斜，然后将这个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>对应的数据单独提取出来。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3 style='margin-top:0cm;margin-right:67.05pt;margin-bottom:5.35pt;margin-left:
22.8pt'><span lang=EN-US style='font-size:11.0pt;line-height:107%;font-family:
"Arial","sans-serif";mso-fareast-font-family:Arial;font-weight:normal'>2. </span><span
style='font-size:11.0pt;line-height:107%;font-family:"微软雅黑","sans-serif";
mso-bidi-font-family:微软雅黑;font-weight:normal'>不适用场景分析：</span><span
style='font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial;font-weight:normal'> <span lang=EN-US><o:p></o:p></span></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
22.4pt;margin-left:23.05pt;text-indent:0cm'>如果一个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>中导致数据倾斜的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>很多，那么此方案不适用。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>2.7 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>解决方案七：使用随机数以及扩容进行 </span><span lang=EN-US>join </span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>如果在进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>操作时，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>RDD </span><span style='color:red'>中有大量的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>key </span><span style='color:red'>导致数据倾斜</span>，那么进行分拆 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>也没什么意义，此时就只能使用最后一种方案来解决问题了，对于 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>join
</span>操作，我们可以考虑<span style='color:red'>对其中一个 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>RDD </span><span style='color:red'>数据进行扩容，另一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>RDD </span><span style='color:red'>进行稀释后再 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>join</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
6.65pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'>我们会<span
style='color:red'>将原先一样的 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key </span><span
style='color:red'>通过附加随机前缀变成不一样的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>key</span><span
style='color:red'>，然后就可以将这些处理后的</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>“</span><span
style='color:red'>不同 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key”</span><span
style='color:red'>分散到多个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>中去处理，而不是让一个 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>task </span><span
style='color:red'>处理大量的相同 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>key</span>。<span
style='color:red'>这一种方案是针对有大量倾斜 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>key
</span><span style='color:red'>的情况，没法将部分 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>key </span><span style='color:red'>拆分出来进行单独处理，需要对整个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>RDD </span><span style='color:red'>进行数据扩容，对内存资源要求很高</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h3><span lang=EN-US style='font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'>1. </span><span lang=EN-US>核心思想：</span><span lang=EN-US
style='font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'> </span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>选择一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>，使用 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>flatMap
</span>进行扩容，对每条数据的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>添加数值前缀（<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>1~N
</span>的数值），将一条数据映射为多条数据；（扩容）<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>选择另外一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>，进行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>映射操作，每条数据的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>都打上一个随机数作为前缀（<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>1~N </span>的随机数）；（稀释）<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>将两个处理后的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD</span>，进行
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>操作。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:4.85pt;margin-left:15.0pt;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_5316" o:spid="_x0000_i1028" type="#_x0000_t75" style='width:385.2pt;
 height:146.4pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image029.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=642 height=244
src="10_SparkPerformanceOptimizationAndMalfunction.files/image030.jpg" v:shapes="Picture_x0020_5316"><![endif]></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:4.85pt;margin-left:15.0pt;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="图片_x0020_3" o:spid="_x0000_i1027" type="#_x0000_t75" style='width:391.2pt;
 height:164.4pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image031.png"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=652 height=274
src="10_SparkPerformanceOptimizationAndMalfunction.files/image032.jpg" v:shapes="图片_x0020_3"><![endif]></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.65pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.3pt;
margin-bottom:10.75pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%'>图 </span><span lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>3-6 </span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%'>使用随机数以及扩容进行 </span><span lang=EN-US style='font-size:
9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span></p>

<h3><span lang=EN-US style='font-family:宋体;mso-bidi-font-family:Arial'>2. </span><span
style='font-family:宋体'>局限性：</span><span style='font-family:宋体;mso-bidi-font-family:
Arial'> </span><span lang=EN-US style='font-family:宋体'><o:p></o:p></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.5pt;margin-left:21.0pt;text-indent:0cm'>如果两个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>都很大，那么将 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>进行 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>N
</span>倍的扩容显然行不通；使用扩容的方式只能缓解数据倾斜，不能彻底解决数据倾斜问题。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h3><span lang=EN-US style='font-family:宋体;mso-bidi-font-family:Arial'>3. </span><span
style='font-family:宋体'>使用方案七对方案六进一步优化分析：</span><span style='font-family:宋体;
mso-bidi-font-family:Arial'> </span><span lang=EN-US style='font-family:宋体'><o:p></o:p></span></h3>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>中有几个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>key
</span>导致数据倾斜时，方案六不再适用，而方案七又非常消耗资源，此时可以引入方案七的思想完善方案六：<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>对包含少数几个数据量过大的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>的那个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>，通过 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>sample
</span>算子采样出一份样本来，然后统计一下每个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>key </span>的数量，计算出来数据量最大的是哪几个 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
2.65pt;margin-left:0cm;line-height:110%;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:110%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>然后将这几个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>对应的数据从原来的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>中拆分出来，形成一个单独的</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD</span>，并给每个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>都打上 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>n </span>以内的随机数作为前缀，而不会导致倾斜的大部分 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>形成另外一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>接着将需要
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>的另一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>，也过滤出来那几个倾斜 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>对应的数据并形成一个单独的 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD</span>，将每条数据膨胀成
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>n </span>条数据，这 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>n </span>条数据都按顺序附加一个</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>0~n </span>的前缀，不会导致倾斜的大部分
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>也形成另外一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD</span>。<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>再将附加了随机前缀的独立
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>与另一个膨胀 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>n </span>倍的独立 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD
</span>进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join</span>，此时就可以将原先相同的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>key </span>打散成 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>n </span>份，分散到多个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>中去进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>了。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:0cm;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>而另外两个普通的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>就照常 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>join </span>即可。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
33.5pt;margin-left:0cm;line-height:110%;mso-list:l4 level1 lfo8'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:110%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>6.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>最后将两次
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>的结果使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>union </span>算子合并起来即可，就是最终的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>join </span>结果。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h1 style='margin-top:0cm;margin-right:0cm;margin-bottom:18.0pt;margin-left:
0cm;text-indent:0cm'>第三章 <b style='mso-bidi-font-weight:normal'><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark Troubleshooting </span></b></h1>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:15.45pt;margin-left:
-.25pt'><span lang=EN-US>3.1 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除一：控制 </span><span lang=EN-US>reduce </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>端缓冲大小以避免 </span><span
lang=EN-US>OOM </span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Shuffle </span>过程，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
</span>端 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>并不是等到 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map
</span>端 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>将其数据全部写入磁盘后再去拉取，而是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>map </span>端写一点数据，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>就会拉取一小部分数据，然后立即进行后面的聚合、算子函数的使用等操作。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task
</span>能够拉取多少数据，由 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>拉取数据的缓冲区 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>buffer </span>来决定，因为拉取过来的数据都是先放在 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>buffer
</span>中，然后再进行后续的处理，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>buffer </span>的默认大小为 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>48MB</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:22.65pt;line-height:125%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>reduce </span><span style='color:red'>端 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>task </span><span style='color:red'>会一边拉取一边计算，不一定每次都会拉满 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>48MB </span><span style='color:red'>的数据，可能大多数时候拉取一部分数据就处理掉了</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>虽然说增大 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端缓冲区大小可以减少拉取次数，提升 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Shuffle </span>性能，但是有时 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>map </span>端的数据量非常大，写出的速度非常快，此时
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce </span>端的所有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>在拉取的时候，有可能全部达到自己缓冲的最大极限值，即
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>48MB</span>，此时，再加上 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端执行的聚合函数的代码，可能会创建大量的对象，这可难会导致内存溢出，即</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
2.2pt;margin-left:-.25pt;text-indent:-.5pt;line-height:107%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>OOM</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>如果一旦出现 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端内存溢出的问题，我们可以考虑减小 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>reduce </span>端拉取数据缓冲区的大小，例如减少为 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>12MB</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:1.65pt;margin-left:-.75pt;text-align:left;line-height:125%'>在实际生产环境中是出现过这种问题的，这是典型的<span
style='color:red'>以性能换执行</span>的原理。 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端拉取数据的缓冲区减小，不容易导致 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>OOM</span>，但是相应的，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reudce </span>端的拉取次数增加，造成更多的网络传输开销，造成性能的下降。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:0cm;line-height:125%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>注意，<span style='color:red'>要保证任务能够运行，再考虑性能的优化</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>3.2 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体'>故障排除二：</span><span lang=EN-US>JVM GC </span><span style='font-family:黑体;
mso-bidi-font-family:黑体'>导致的 </span><span lang=EN-US>shuffle </span><span
style='font-family:黑体;mso-bidi-font-family:黑体'>文件拉取失败</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>在 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>作业中，有时会出现
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>shuffle file not found </span>的错误，这是非常常见的一个报错，有时出现这种错误以后，选择重新执行一遍，就不再报出这种错误。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:0cm;line-height:125%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span><span style='color:red'>出现上述问题可能的原因是 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Shuffle </span><span style='color:red'>操作中，后面 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stage </span><span style='color:red'>的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>想要去上一个 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>stage </span><span style='color:red'>的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>task </span><span style='color:red'>所在的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Executor </span><span style='color:red'>拉取数据，结果对方正在执行
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>GC</span><span
style='color:red'>，执行 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>GC </span><span
style='color:red'>会导致 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>Executor </span><span
style='color:red'>内所有的工作现场全部停止，比如 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>BlockManager</span><span
style='color:red'>、基于 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>netty </span><span
style='color:red'>的网络通信等，这就会导致后面的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>task
</span><span style='color:red'>拉取数据拉取了半天都没有拉取到，就会报出 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>shuffle file not found </span><span style='color:red'>的错误</span>，而第二次再次执行就不会再出现这种错误。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.3pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>可以通过调整 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
</span>端拉取数据重试次数和 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>reduce </span>端拉取数据时间间隔这两个参数来对 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Shuffle </span>性能进行调整，增大参数值，使得 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>reduce
</span>端拉取数据的重试次数增加，并且每次失败后等待的时间间隔加长。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.5pt;
margin-bottom:2.55pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>4-1 JVM GC</span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>导致的</span><span lang=EN-US style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Arial","sans-serif";
mso-fareast-font-family:Arial'>shuffle</span><span style='font-size:9.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:黑体;mso-bidi-font-family:
黑体'>文件拉取失败</span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.15pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>val conf = new SparkConf() </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.0pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.io.maxRetries</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;60&quot;) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:27.05pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:110%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:110%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'><span style='mso-spacerun:yes'> 
</span>.set(&quot;</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:110%;font-family:"Courier New";mso-fareast-font-family:"Courier New";
color:#00B0F0'>spark.shuffle.io.retryWait</span><span lang=EN-US
style='font-size:8.0pt;mso-bidi-font-size:11.0pt;line-height:110%;font-family:
"Courier New";mso-fareast-font-family:"Courier New"'>&quot;, &quot;60s&quot;) </span></p>

<h2><span lang=EN-US>3.3 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除三：解决各种序列化导致的报错</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>当 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Spark </span>作业在运行过程中报错，而且报错信息中含有
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Serializable </span>等类似词汇，那么可能是序列化问题导致的报错。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span>序列化问题要注意以下三点：<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:42.0pt;text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo9'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>作为 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>的元素类型的自定义类，必须是可以序列化的</span>；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:42.0pt;text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo9'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>算子函数里可以使用的外部的自定义变量，必须是可以序列化的</span>；<span style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.45pt;margin-bottom:
.2pt;margin-left:42.0pt;text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo9'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='color:red'>不可以在 </span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>RDD </span><span
style='color:red'>的元素类型、算子函数里使用第三方的不支持序列化的类型，例如</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.25pt;margin-bottom:
22.2pt;margin-left:42.5pt;text-indent:-.5pt;line-height:127%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Connection</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<h2><span lang=EN-US>3.4 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除四：解决算子函数返回 </span><span lang=EN-US>NULL </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>导致的问题</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在一些算子函数里，需要我们有一个返回值，但是在一些情况下我们不希望有返回值，此时我们如果直接返回 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>NULL</span>，会报错，例如 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Scala.Math(NULL)</span>异常。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;text-indent:0cm'>如果你遇到某些情况，不希望有返回值，那么可以通过下述方式解决：<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;mso-list:l9 level1 lfo10'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>返回特殊值，不返回
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>NULL</span>，例如<span lang=EN-US>“</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>-1</span><span
lang=EN-US>”</span>；<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;mso-list:l9 level1 lfo10'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>在通过算子获取到了一个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>之后，可以对这个 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>RDD </span>执行
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>filter </span>操作，进行数据过滤，将数值为<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>-1
</span>的数据给过滤掉；<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:23.05pt;mso-list:l9 level1 lfo10'><![if !supportLists]><span
lang=EN-US style='mso-bidi-font-size:10.5pt;line-height:125%;font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]>在使用完
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>filter </span>算子后，继续调用 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>coalesce </span>算子进行优化。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>3.5 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除五：解决 </span><span lang=EN-US>YARN-CLIENT </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>模式导致的网卡流量激增问题</span>
</h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
4.4pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>YARN-client
</span>模式的运行原理如下图所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:-.75pt;
margin-bottom:11.05pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_5869" o:spid="_x0000_i1026" type="#_x0000_t75" style='width:436.8pt;
 height:267.6pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image033.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=728 height=446
src="10_SparkPerformanceOptimizationAndMalfunction.files/image034.jpg" v:shapes="Picture_x0020_5869"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>4-1
YARN-client </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>模式运行原理</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>在 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>YARN-client </span>模式下，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Driver </span>启动在本地机器上，而 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Driver </span>负责所有的任务调度，需要与
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>YARN </span>集群上的多个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Executor </span>进行频繁的通信。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>假设有 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>100 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor</span>，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> 1000 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task</span>，那么每个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor
</span>分配到 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>10 </span>个 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>task</span>，之后，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Driver </span>要频繁地跟 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Executor </span>上运行的
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>1000 </span>个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>task </span>进行通信，通信数据非常多，并且通信品类特别高。这就导致有可能在
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>任务运行过程中，由于频繁大量的网络通讯，本地机器的网卡流量会激增。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>注意，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>YARN-client </span>模式只会在测试环境中使用，而之所以使用
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>YARN-client </span>模式，是由于可以看到详细全面的 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>log
</span>信息，通过查看 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>log</span>，可以锁定程序中存在的问题，避免在生产环境下发送故障。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;line-height:125%'><span
style='color:red'>在生产环境下，使用的一定是 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>YARN-cluster
</span><span style='color:red'>模式</span>。在 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>YARN-cluster
</span>模式下，就不会造成本地机器网卡流量激增问题，如果 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>YARN-cluster </span>模式下存在网络通信的问题，需要运维团队进行解决。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>3.6 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除六：解决 </span><span lang=EN-US>YARN-CLUSTER </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>模式的 </span><span
lang=EN-US>JVM </span><span style='font-family:黑体;mso-bidi-font-family:黑体;
font-weight:normal'>栈内存溢出无法执行问题</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
4.3pt;margin-left:23.05pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>YARN-cluster
</span>模式的运行原理如下图所示：<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:7.9pt;
margin-bottom:9.15pt;margin-left:.5pt;text-align:right;text-indent:-.5pt;
line-height:104%'><span lang=EN-US style='mso-no-proof:yes'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_6021" o:spid="_x0000_i1025" type="#_x0000_t75" style='width:429pt;
 height:175.2pt;visibility:visible;mso-wrap-style:square'>
 <v:imagedata src="10_SparkPerformanceOptimizationAndMalfunction.files/image035.jpg"
  o:title=""/>
</v:shape><![endif]--><![if !vml]><img width=715 height=292
src="10_SparkPerformanceOptimizationAndMalfunction.files/image036.jpg" v:shapes="Picture_x0020_6021"><![endif]></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'> </span></span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%'>图 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:104%;
font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>4-1
YARN-client </span><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:104%'>模式运行原理</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:104%;font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>当 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>作业中包含 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>SparkSQL
</span>的内容时，可能会碰到 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>YARN-client </span>模式下可以运行，但是 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>YARN-cluster </span>模式下无法提交运行（报出 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>OOM
</span>错误）的情况。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:18.95pt;margin-bottom:
.2pt;margin-left:-.75pt;text-indent:0cm;line-height:125%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span></span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>YARN-client
</span><span style='color:red'>模式下，</span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>Driver
</span><span style='color:red'>是运行在本地机器上的，</span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>Spark </span><span style='color:red'>使用的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>JVM </span><span style='color:red'>的 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>PermGen </span><span style='color:red'>的配置，是本地机器上的 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>spark-class </span><span style='color:red'>文件，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>JVM </span><span style='color:red'>永久代的大小是 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>128MB</span><span style='color:red'>，这个是没有问题的，但是在 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>YARN-cluster </span><span style='color:red'>模式下，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>Driver </span><span style='color:red'>运行在 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>YARN </span><span style='color:red'>集群的某个节点上，使用的是没有经过配置的默认设置，</span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>PermGen </span><span style='color:red'>永久代大小为 </span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>82MB</span>。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:14.8pt;
margin-bottom:.45pt;margin-left:-.75pt;text-align:left;text-indent:0cm;
line-height:125%'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span><span style='mso-tab-count:1'>      </span>SparkSQL
</span>的内部要进行很复杂的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>SQL </span>的语义解析、语法树转换等等，非常复杂，如果 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>sql </span>语句本身就非常复杂，那么很有可能会导致性能的损耗和内存的占用，特别是对 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>PermGen </span>的占用会比较大。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:3.25pt;
margin-bottom:1.85pt;margin-left:0cm;text-align:center;text-indent:0cm;
line-height:107%'>所以，此时如果 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>PermGen </span>的占用刚好过了 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>82MB</span>，但是又小于 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>128MB</span>，就会出现</p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.55pt;margin-bottom:
1.85pt;margin-left:-.25pt;text-indent:-.5pt;line-height:107%'><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>YARN-client
</span>模式下可以运行，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>YARN-cluster </span>模式下无法运行的情况。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
6.65pt;margin-left:-.75pt'>解决上述问题的方法时增加 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>PermGen </span>的容量，需要在
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>spark-submit </span>脚本中对相关参数进行设置，设置方法如代码清单 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>4-2
</span>所示。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.4pt;
margin-bottom:2.65pt;margin-left:.5pt;text-align:center;text-indent:-.5pt;
line-height:107%'><span style='font-size:9.0pt;mso-bidi-font-size:11.0pt;
line-height:107%;font-family:黑体;mso-bidi-font-family:黑体'>代码清单 </span><span
lang=EN-US style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;
font-family:"Arial","sans-serif";mso-fareast-font-family:Arial'>4-2 </span><span
style='font-size:9.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:
黑体;mso-bidi-font-family:黑体'>配置</span><span style='font-size:9.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Arial","sans-serif";mso-fareast-font-family:
Arial'> </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.1pt;margin-left:-.25pt;text-align:left;text-indent:-.5pt;
line-height:107%;background:#E0E0E0'><span lang=EN-US style='font-size:8.0pt;
mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New"'>--conf
spark.driver.extraJavaOptions=&quot;</span><span lang=EN-US style='font-size:
8.0pt;mso-bidi-font-size:11.0pt;line-height:107%;font-family:"Courier New";
mso-fareast-font-family:"Courier New";color:#00B0F0'>-XX:PermSize=128M
-XX:MaxPermSize=256M</span><span lang=EN-US style='font-size:8.0pt;mso-bidi-font-size:
11.0pt;line-height:107%;font-family:"Courier New";mso-fareast-font-family:"Courier New"'>&quot;
</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.25pt;margin-left:-.75pt'>通过上述方法就设置了 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Driver </span>永久代的大小，默认为
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>128MB</span>，最大 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>256MB</span>，这样就可以避免上面所说的问题。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
21.25pt;margin-left:-.75pt'>在集群上，假如想停止<span lang=EN-US>SparkStreaming</span>（这个一般都是<span
lang=EN-US>24</span>小时都在执行的），那么可以在<span lang=EN-US>SparkStreaming</span>启动之前起一个线程，让这个线程去监听<span
lang=EN-US>HDFS</span>的一个目录，如果这个目录不存在或不存在，则调用<span lang=EN-US>SparkStreaming</span>的<span
lang=EN-US>stop</span>方法，停止集群，这是一个标准的方法，本地执行一般都是直接<span lang=EN-US>kill</span>。</p>

<h2><span lang=EN-US>3.7 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除七：解决 </span><span lang=EN-US>SparkSQL </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>导致的 </span><span
lang=EN-US>JVM </span><span style='font-family:黑体;mso-bidi-font-family:黑体;
font-weight:normal'>栈内存溢出</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span><span style='mso-spacerun:yes'>       </span></span>当
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>SparkSQL </span>的 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>sql </span>语句有成百上千的 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>or </span>关键字时，就可能会出现 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>Driver </span>端的<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>JVM </span>栈内存溢出。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:20.8pt;margin-bottom:
21.5pt;margin-left:-.75pt;text-indent:0cm'><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'><span
style='mso-spacerun:yes'> </span><span style='mso-spacerun:yes'>       </span></span><span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman";color:red'>JVM </span><span style='color:red'>栈内存溢出基本上就是由于调用的方法层级过多，产生了大量的，非常深的，超出了
</span><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman";color:red'>JVM </span><span
style='color:red'>栈深度限制的递归</span>。（我们猜测 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>SparkSQL </span>有大量
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>or </span>语句的时候，在解析 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>SQL </span>时，例如转换为语法树或者进行执行计划的生成的时候，对于
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>or </span>的处理是递归，<span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>or </span>非常多时，会发生大量的递归）<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'><span style='mso-spacerun:yes'>  </span></span>此时，建议将一条 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>sql </span>语句拆分为多条 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>sql </span>语句来执行，每条 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>sql </span>语句尽量保证 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>100 </span>个以内的子句。<span
style='color:red'>根据实际的生产环境试验，一条 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>sql
</span><span style='color:red'>语句的 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>or
</span><span style='color:red'>关键字控制在 </span><span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";color:red'>100
</span><span style='color:red'>个以内，通常不会导致 </span><span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman";
color:red'>JVM </span><span style='color:red'>栈内存溢出</span>。<span
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>
</span></p>

<h2><span lang=EN-US>3.8 </span><span style='font-family:黑体;mso-bidi-font-family:
黑体;font-weight:normal'>故障排除八：持久化与 </span><span lang=EN-US>checkpoint </span><span
style='font-family:黑体;mso-bidi-font-family:黑体;font-weight:normal'>的使用</span> </h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'><span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>Spark </span>持久化在大部分情况下是没有问题的，但是有时数据可能会丢失，如果数据一旦丢失，就需要对丢失的数据重新进行计算，计算完后再缓存和使用，为了避免数据的丢失，可以选择对这个
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>RDD </span>进行 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>checkpoint</span>，也就是将数据持久化一份到容错的文件系统上（比如
<span lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>HDFS</span>）。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:24.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>一个 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>RDD </span>缓存并 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>checkpoint
</span>后，如果一旦发现缓存丢失，就会优先查看 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>checkpoint </span>数据存不存在，如果有，就会使用 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>checkpoint </span>数据，而不用重新计算。也即是说，<span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>checkpoint
</span>可以视为 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>cache </span>的保障机制，如果 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>cache </span>失败，就使用 <span lang=EN-US style='font-family:
"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>checkpoint
</span>的数据。<span style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'> </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>使用 <span lang=EN-US style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'>checkpoint </span>的优点在于提高了 <span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>Spark </span>作业的可靠性，一旦缓存出现问题，不需要重新计算数据，缺点在于，<span
lang=EN-US style='font-family:"Times New Roman","serif";mso-fareast-font-family:
"Times New Roman"'>checkpoint </span>时需要将数据写入 <span lang=EN-US
style='font-family:"Times New Roman","serif";mso-fareast-font-family:"Times New Roman"'>HDFS
</span>等文件系统，对性能的消耗较大。<span style='font-family:"Times New Roman","serif";
mso-fareast-font-family:"Times New Roman"'> <span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:19.6pt;margin-bottom:
.45pt;margin-left:-.75pt'>老版本的缓存必须要接一下，即<span lang=EN-US>rdd1=rdd.cache()</span></p>

</div>

</body>

</html>
